---
title: Cumulative
author: David Kane and Aashna Patel
tutorial:
  id: 111-cumulative
output:
  learnr::tutorial:
    progressive: yes
    allow_skip: yes
runtime: shiny_prerendered
description: "Tutorial #11 for Preceptor's Primer"
---

```{r setup, include = FALSE}
library(learnr)
library(tutorial.helpers)
library(gt)

library(tidyverse)
library(broom)
library(primer.data)
library(marginaleffects)

library(easystats)

knitr::opts_chunk$set(echo = FALSE)
options(tutorial.exercise.timelimit = 600, 
        tutorial.storage = "local") 

# Should "High School Graduate" be "High School"?

x <- ces |>
  filter(year == 2020) |>
  select(approval, ideology, education) |>
  drop_na() |> 
  filter(! ideology %in% "Not Sure") |> 
  mutate(ideology = fct_drop(ideology))


# This model used to include faminc as well. There was nothing wrong with that,
# per se. But this model (the first to be ordinal) is always complex enough
# without that.

# There is no ordinal model which works with tidymodels. So, we don't bother
# with tidymodels. And that is OK!

set.seed(9)

fit_approval <- MASS::polr(approval ~ ideology + education,
                      data = x)

# tidy() takes so long to run that it makes sense to save the basic table so
# that the setup code chunk and the interpretation questions go quicker.

# tidy_approval <- tidy(fit_approval, conf.int = TRUE) 
# write_rds(tidy_approval, file = "data/tidy_approval.rds")
tidy_approval <- read_rds("data/tidy_approval.rds")
```

```{r copy-code-chunk, child = system.file("child_documents/copy_button.Rmd", package = "tutorial.helpers")}
```

```{r info-section, child = system.file("child_documents/info_section.Rmd", package = "tutorial.helpers")}
```

## Introduction
### 

This tutorial supports [*Preceptor’s Primer for Bayesian Data Science: Using the Cardinal Virtues for Inference*](https://ppbds.github.io/primer/) by [David Kane](https://davidkane.info/). 

The world confronts us. Make decisions we must.

Imagine you’re a pollster preparing for the upcoming election. You turn to 2020 approval ratings to explore possible patterns in how different education levels relate to support for Trump. You’re curious whether any groups tend to approve or disapprove more than others. As you look for correlations, you start thinking about how this might inform your polling strategy—how to design your questions, which groups to focus on. The data might offer useful insights, but there’s still a lot to uncover. There are many decisions to make.

### Exercise 1

What are the four [Cardinal Virtues](https://en.wikipedia.org/wiki/Cardinal_virtues), in order, which we use to guide our data science work?

```{r introduction-1}
question_text(NULL,
	message = "Wisdom, Justice, Courage, and Temperance.",
	answer(NULL, correct = TRUE),
	allow_retry = FALSE,
	incorrect = NULL,
	rows = 2)
```

###

Why do we ask this, and a score more other questions, in each tutorial? Because the best way to (try to) ensure that students remember these concepts more than a few months after the course ends is [spaced repetition](https://en.wikipedia.org/wiki/Spaced_repetition), although we focus more on the repetition than on the spacing.

## The Question
### 

*The power to question is the basis of all human progress.* - Indira Gandhi

To make better decisions about how to reach voters, we need to ask: how do ideology and education level shape voter approval? Are voters with more education and moderate views more likely to disapprove of certain candidates? And if so, what might that suggest about how opinions shift across demographics? These answers won’t solve every campaign challenge, but they can help us make smarter choices about where to focus messaging and outreach.

### Exercise 1

Load [**tidyverse**](https://www.tidyverse.org/) package.

```{r the-question-1, exercise = TRUE}

```

```{r the-question-1-hint-1, eval = FALSE}
library(tidyverse)
```

```{r the-question-1-test, include = FALSE}
library(tidyverse)
```

### 

The data we’ll be using in this tutorial comes from the [Cooperative Election Study](https://cces.gov.harvard.edu/) (CES), one of the largest political surveys in the United States, where respondents rate how much they approve of the current president.

### Exercise 2

Load the [**primer.data**](https://ppbds.github.io/primer.data/) package.

```{r the-question-2, exercise = TRUE}

```

```{r the-question-2-hint-1, eval = FALSE}
library(primer.data)
```

```{r the-question-2-test, include = FALSE}
library(primer.data)
```

### 

A version of the data from CES is available in the `ces` tibble.

### Exercise 3

After loading **primer.data** in your Console, type `?ces` in the Console, and paste in the Description below.

```{r the-question-3}
question_text(NULL,
	answer(NULL, correct = TRUE),
	allow_retry = TRUE,
	try_again_button = "Edit Answer",
	incorrect = NULL,
	rows = 3)
```

### 

The [Cooperative Election Study](https://cces.gov.harvard.edu/) is a large national survey of over 50,000 Americans conducted every election year. It includes questions about political views, voting behavior, ideology, education, and approval of elected officials.

### Exercise 4

Approval is the broad topic of this tutorial. Given that topic, which variable in `ces` should we use as our outcome variable? 

```{r the-question-4}
question_text(NULL,
	message = "The `approval` variable shows the approval of the president.",
	answer(NULL, correct = TRUE),
	allow_retry = FALSE,
	incorrect = NULL,
	rows = 2)
```

### 

We will use `approval` as our outcome variable.

```{r}
x |> 
  ggplot(aes(approval)) +
    geom_bar() +
    labs(
      title = "2020 Presidential Approval",
      subtitle = "A lot of people strongly disapproved of President Trump",
      x = NULL,
      y = "Number",
      caption = "Source: Cooperative Election Study") +
    coord_flip()
```

### Exercise 5

Let's imagine a brand new variable which **does not exist** in the data. This variable should be binary, meaning that it only takes on one of two values. It should also, at least in theory, be manipulable. In other words, if the value of the variable is "3," or whatever, then it generates one potential outcome and if it is "9," or whatever, it generates another potential outcome.

Describe this imaginary variable and how might we manipulate its value.

```{r the-question-5}
question_text(NULL,
	message = "Imagine a variable called ads which has a value of 1 if a person was exposed to positive Facebook ads and 0 if they were not. The organization running the campaign can control this variable by deciding, either randomly or otherwise, whether or not to show these ads to a specific individual. This allows us to measure the causal effect of ads on presidential approval.",
	answer(NULL, correct = TRUE),
	allow_retry = FALSE,
	incorrect = NULL,
	rows = 6)
```

### 

Any data set can be used to construct a causal model as long as there is at least one covariate that we can, at least in theory, manipulate. It does not matter whether or not anyone did, in fact, manipulate it. 

### Exercise 6

Given our (imaginary) treatment variable `ads`, how many potential outcomes are there for each person? Explain why.

```{r the-question-6}
question_text(NULL,
	message = "There are 2 potential outcomes because the treatment variable `ads` takes on 2 posible values: 0 (if the person did not see the ads) or 1 (if the person did see the ads).",
	answer(NULL, correct = TRUE),
	allow_retry = FALSE,
	incorrect = NULL,
	rows = 6)
```

### 

The same data set can be used to create, separately, lots and lots of different models, both causal and predictive. We can just use different outcome variables and/or specify different treatment variables. This is a *conceptual* framework we apply to the data. It is never inherent in the data itself.

### Exercise 7

In a few sentences, specify the two different values for the imaginary treatment variable `ads`, for a single unit, guess at the potential outcomes which would result, and then determine the causal effect for that unit given those guesses.

```{r the-question-7}
question_text(NULL,
	message = 'For a given person, assume that the value of the treatment variable might be 1 (treatment) or 0 (control). If the person gets 1, then `approval` would be "Strongly Approve." If the person gets 0, then `approval` would be "Neither Approve nor Disapprove." The causal effect on the outcome of a treatment of 1 versus 0 is "Strongly Approve" minus "Neither Approve nor Disapprove" — i.e., the difference between two potential outcomes — which equals the individual causal effect for this person.',
	answer(NULL, correct = TRUE),
	allow_retry = FALSE,
	incorrect = NULL,
	rows = 6)
```

### 

A causal effect is defined as the difference between two potential outcomes. However, you can’t simply say the effect is 10 without specifying the order of subtraction. There is, perhaps, a default sense in which the causal effect is defined as treatment minus control.

Any causal connection means exploring the *within row* difference between two potential outcomes. There's no need to consider other rows.

### Exercise 8

Let's consider a *predictive* model. Which variable in `ces` do you think might have an important connection to `approval`?

```{r the-question-8}
question_text(NULL,
	message = "The ideology of an individual could be connected to their approval of the president. If the president is a Republican, we might expect more conservative individuals to have stronger measured approval.",
	answer(NULL, correct = TRUE),
	allow_retry = FALSE,
	incorrect = NULL,
	rows = 2)
```

### 

With a predictive model, each individual unit has only one observed outcome. There are no two potential outcomes because none of the covariates are treated as treatment variables. Instead, all covariates are assumed to be "fixed."

Predictive models have no "treatments"—only covariates.

### Exercise 9

Specify two different groups of people that have different values for `ideology` and which might have different average values for the outcome variable `approval`.

```{r the-question-9}
question_text(NULL,
	message = "Consider two groups, the first with a value for `ideology` of Very Liberal and the second with a value of Very Conservative. Those two groups might have different average values for the outcome variable, presidential approval.",
	answer(NULL, correct = TRUE),
	allow_retry = FALSE,
	incorrect = NULL,
	rows = 6)
```

### 

In predictive models, do not use words like "cause," "influence," "impact," or anything else which suggests causation. The best phrasing is in terms of "differences" between groups of units with different values for a covariate of interest.

### Exercise 10

Write a predictive question which connects the outcome variable `approval` to `ideology`, the covariate of interest.

```{r the-question-10}
question_text(NULL,
	message = "What is the average difference in presidential approval between people who are Very Liberal and those who are Very Conservative?",
	answer(NULL, correct = TRUE),
	allow_retry = FALSE,
	incorrect = NULL,
	rows = 6)
```

### 

The answer to this question is your "Quantity of Interest." 

Our Quantity of Interest might appear too specific, too narrow to capture the full complexity of the topic. There are many, many numbers in which we are interested, many numbers that we want to know. But we don't need to list them all here! We just need to choose one of them since our goal is just to have a specific number which helps to guide us in the creation of the Preceptor Table and, then, the model.

## Wisdom
### 

*The doorstep to the temple of wisdom is a knowledge of our own ignorance.* - Benjamin Franklin

Our question:

> *What is the average difference in presidential approval between people who are Very Liberal and those who are Very Conservative?*

### Exercise 1

In your own words, describe the key components of Wisdom when working on a data science problem.

```{r wisdom-1}
question_text(NULL,
	message = "Wisdom requires the creation of a Preceptor Table, an examination of our data, and a determination, using the concept of validity, as to whether or not we can (reasonably!) assume that the two come from the same population.",
	answer(NULL, correct = TRUE),
	allow_retry = FALSE,
	incorrect = NULL,
	rows = 6)
```

### 

The central problem for Wisdom is: Can we use survey data from the Cooperative Election Study to understand presidential approval and ideology for all adults in the US?

### Exercise 2

Define a Preceptor Table.

```{r wisdom-2}
question_text(NULL,
	message = "A Preceptor Table is the smallest possible table of data with rows and columns such that, if there is no missing data, we can easily calculate the quantities of interest.",
	answer(NULL, correct = TRUE),
	allow_retry = FALSE,
	incorrect = NULL,
	rows = 6)
```

### 

The Preceptor Table does not include all the covariates which you will eventually include in your model. It only includes covariates which you need to answer your question.

> How does average presidential approval vary across ideology groups?
Ideology strongly influences political opinions.

> Within each ideology group, how does education relate to approval?
Education can affect how people view the president.

### Exercise 3

Describe the key components of Preceptor Tables in general, without worrying about this specific problem. Use words like "units," "outcomes," and "covariates."

```{r wisdom-3}
question_text(NULL,
	message = "The rows of the Preceptor Table are the units. The outcome is at least one of the columns. If the problem is causal, there will be at least two (potential) outcome columns. The other columns are covariates. If the problem is causal, at least one of the covariates will be a treatment.",
	answer(NULL, correct = TRUE),
	allow_retry = FALSE,
	incorrect = NULL,
	rows = 6)
```

### 

This problem is predictive, so we will compare the outcome, presidential approval, between two groups that differ in ideology.

### Exercise 4

Create a Github repo called `cumulative`. Make sure to click the "Add a README file" check box.

Connect the Github repo to a project on your computer. Use a folder name which matches your repo name.

Select `File -> New File -> Quarto Document ...`. Provide a title -- `"Cumulative"` -- and an author (you). Render the document and save it as `analysis.qmd`.

Edit the `.gitignore` by adding `*_files` and a blank line. Save and push.

In the Console, run:

```         
show_file(".gitignore")
```

CP/CR.

```{r wisdom-4}
question_text(NULL,
	answer(NULL, correct = TRUE),
	allow_retry = TRUE,
	try_again_button = "Edit Answer",
	incorrect = NULL,
	rows = 3)
```

### 

We model units, but we only really care about aggregates.

### Exercise 5

What are the units for this problem?

```{r wisdom-5}
question_text(NULL,
	message = "Adults in the United States of America.",
	answer(NULL, correct = TRUE),
	allow_retry = FALSE,
	incorrect = NULL,
	rows = 6)
```

### 

Specifying the Preceptor Table forces us to think clearly about the units and outcomes implied by the question. The resulting discussion sometimes leads us to modify the question with which we started. No data science project follows a single direction. We always backtrack. There is always dialogue.

### Exercise 6

What is the outcome variable for this problem?

```{r wisdom-6}
question_text(NULL,
	message = "Keep track of the outcome variable related to presidential approval. In this case, approval represents respondents’ approval rating of the president.",
	answer(NULL, correct = TRUE),
	allow_retry = FALSE,
	incorrect = NULL,
	rows = 6)
```

### 

`approval` has five ordered values, ranging from strong approval to strong disapproval. If it had only two values, we’d focus on just those two.

### Exercise 7

What is a covariate which you think might be useful for this problem, regardless of whether or not it might be included in the data?

```{r wisdom-7}
question_text(NULL,
	message = "Sex and race could have a relationship with the approval of the president.",
	answer(NULL, correct = TRUE),
	allow_retry = FALSE,
	incorrect = NULL,
	rows = 6)
```

### 

The term "covariates" is used in at least three ways in data science. First, it is all the variables which might be useful, regardless of whether or not we have the data. Second, it is all the variables for which we have data. Third, it is the set of variables in the data which we end up using in the model.

### Exercise 8

What are the treatments, if any, for this problem?

```{r wisdom-8}
question_text(NULL,
	message = "There are no treatments.",
	answer(NULL, correct = TRUE),
	allow_retry = FALSE,
	incorrect = NULL,
	rows = 6)
```

### 

Remember that a treatment is just another covariate which, for the purposes of this specific problem, we are assuming can be manipulated, thereby, creating two or more different potential outcomes for each unit.

### Exercise 9

What moment in time does the Preceptor Table refer to?

```{r wisdom-9}
question_text(NULL,
	message = "2020",
	answer(NULL, correct = TRUE),
	allow_retry = FALSE,
	incorrect = NULL,
	rows = 6)
```

### 


```{r}
results <- plot_predictions(fit_approval,
                            condition = c("ideology"),
                            draw = FALSE)

results$group <- factor(results$group, levels = c(
  "Strongly Approve",
  "Approve / Somewhat Approve",
  "Neither Approve nor Disapprove",
  "Disapprove / Somewhat Disapprove",
  "Strongly Disapprove"
))

ggplot(results, aes(x = ideology, y = estimate, fill = group)) +
  geom_col(position = "stack") +
  labs(
    title = "Presidential Approval by Ideology",
    subtitle = "Different ideology groups show different approval levels",
    x = "Ideology",
    y = "Probability",
    fill = "Approval"
  ) +
  theme_minimal()
```

> *You can never look at the data too much. -- Mark Engerman*

### Exercise 10

Define causal effect.

```{r wisdom-10}
question_text(NULL,
	message = "A causal effect is the difference between two potential outcomes.",
	answer(NULL, correct = TRUE),
	allow_retry = FALSE,
	incorrect = NULL,
	rows = 6)
```

### 

According to the Rubin Causal Model, there must be two (or more) potential outcomes for any discussion of causation to make sense. This is simplest to discuss when the treatment only has two different values, thereby generating only two potential outcomes. 

### Exercise 11

What is the fundamental problem of causal inference?

```{r wisdom-11}
question_text(NULL,
	message = "The fundamental problem of causal inference is that we can only observe one potential outcome.",
	answer(NULL, correct = TRUE),
	allow_retry = FALSE,
	incorrect = NULL,
	rows = 6)
```

### 

If the treatment variable is continuous (like income), then there are lots and lots of potential outcomes, one for each possible value of the treatment variable. 

### Exercise 12

How does the motto "No causation without manipulation" apply in this problem?

```{r wisdom-12}
question_text(NULL,
	message = "Since the data is only a survey, without any manipulation, we cannot make any causal inferences.",
	answer(NULL, correct = TRUE),
	allow_retry = FALSE,
	incorrect = NULL,
	rows = 6)
```

### 

The motto does not apply because this is a predictive, not causal, model.

### Exercise 13

Describe in words the Preceptor Table for this problem.

```{r wisdom-13}
question_text(NULL,
	message = "The Preceptor Table has 3 columns. There is a column for the ID, and one for the outcome. There will be a column for ideology Each row represents one individual.",
	answer(NULL, correct = TRUE),
	allow_retry = FALSE,
	incorrect = NULL,
	rows = 6)
```

### 

The Preceptor Table for this problem looks something like this:

```{r}
#| echo: false
tibble(ID = c("1", "2", "...", "10", "11", "...", "N"),
       approval = c("Neither Approve Nor Disapprove", "Disapprove / Somewhat Disapprove", "...", "Strongly Approve", "Never Heard / Not Sure", "...", "Neither Approve Nor Disapprove"),
       ideology = c("Moderate", "Very Liberal", "...", "Moderate", "Not Sure", "...", "Conservative")) |>
  
  gt() |>
  tab_header(title = "Preceptor Table") |> 
  cols_label(ID = md("ID"),
             approval = md("Approval of the President"),
             ideology = md("Political Ideology")) |>
  tab_style(cell_borders(sides = "right"),
            location = cells_body(columns = c(ID))) |>
  tab_style(style = cell_text(align = "left", v_align = "middle", size = "large"), 
            locations = cells_column_labels(columns = c(ID))) |>
  cols_align(align = "center", columns = everything()) |>
  cols_align(align = "left", columns = c(ID)) |>
  fmt_markdown(columns = everything()) |>
  tab_spanner(label = "Covariates", columns = c(ideology)) |>
  tab_spanner(label = "Outcomes", columns = c(approval))
```

### Exercise 14

In your QMD, load the **tidyverse** and the **primer.data** packages in a new code chunk. Render the file.

Notice that the file does not look good because the code is visible and there are annoying messages. To take care of this, add `#| message: false` to remove all the messages in the `setup` chunk. Also add the following to the YAML header to remove all code echos from the whole file:

```         
execute: 
  echo: false
```

In the Console, run:

```         
show_file("analysis.qmd", start = -5)
```

CP/CR.

```{r wisdom-14}
question_text(NULL,
	answer(NULL, correct = TRUE),
	allow_retry = TRUE,
	try_again_button = "Edit Answer",
	incorrect = NULL,
	rows = 3)
```

### 

Render again. Everything looks nice because we have added code to make the file look better and more professional.

### Exercise 15

Run `glimpse()` on `ces`.

```{r wisdom-15, exercise = TRUE}

```

```{r wisdom-15-hint-1, eval = FALSE}
glimpse(...)
```

```{r wisdom-15-test, include = FALSE}
glimpse(ces)
```

### 

`glimpse()` gives us a look at the raw data contained within the `ces` data set. At the very top of the output, we can see the number of rows and columns, or observations and variables, respectively. We see that there are 617,455 observations, with each row corresponding to a unique respondent.

### Exercise 16

Pipe `ces` to `filter()` with `year` set to `2020` inside of it using `==`.

```{r wisdom-16, exercise = TRUE}

```

```{r wisdom-16-hint-1, eval = FALSE}
ces |> 
  filter(...)
```

```{r wisdom-16-test, include = FALSE}
ces |> 
  filter(year == 2020)
```

### 

We will be focusing on the year 2020 so that we have fewer number of rows to work with.

### Exercise 17

Continue the pipe to `select()` and have `approval`, `education`, and `ideology` inside.

```{r wisdom-17, exercise = TRUE}

```

<button onclick="transfer_code(this)">

Copy previous code

</button>

```{r wisdom-17-hint-1, eval = FALSE}
... |> 
  select(...)
```

```{r wisdom-17-test, include = FALSE}
ces |> 
  filter(year == 2020) |> 
  select(approval, education, ideology)
```

### 

We are selecting only the rows we will use in the future. Of course, we could choose any of the other variables, but we will be focusing on only these four for this tutorial.

### Exercise 18

Finish the pipe with `drop_na()`. Add `slice_sample(n = 2000)` at the very end to only select 2,000 observations from the data.

```{r wisdom-18, exercise = TRUE}

```

<button onclick="transfer_code(this)">

Copy previous code

</button>

```{r wisdom-18-hint-1, eval = FALSE}
... |> drop_na() |>
  slice_sample(...)
```

```{r wisdom-18-test, include = FALSE}
ces |> filter(year == 2020) |> select(approval, education, ideology) |>
  drop_na() |>
  slice_sample(n = 2000)
```

### 

Behind the scenes of this tutorial, we have created an object called `x` using the previous code.

### Exercise 19

To see the object that was created in the background, run `x`.

```{r wisdom-19, exercise = TRUE}

```

```{r wisdom-19-hint-1, eval = FALSE}
x
```

### 

There are now only 54,839 rows which is significantly fewer than the whole `ces` data. Having more manageable data will make it easier for us to create models.

### Exercise 20

In `analysis.qmd`, add a new code chunk. Copy the code from two exercises ago which prepares the data and paste it in the code chunk. Set the code to an object called `x`.

Render the file. In the Console, run:

```         
show_file("analysis.qmd", start = -5)
```

CP/CR.

```{r wisdom-20}
question_text(NULL,
	answer(NULL, correct = TRUE),
	allow_retry = TRUE,
	try_again_button = "Edit Answer",
	incorrect = NULL,
	rows = 3)
```

### 

The CES is a 50,000+ person national stratified sample survey administered by YouGov. Half of the questionnaire consists of Common Content asked of all 50,000+ people, and half of the questionnaire consists of Team Content designed by each individual participating team and asked of a subset of 1,000 people.

### Exercise 21

Pipe `x` to `summary()`.

```{r wisdom-21, exercise = TRUE}

```

```{r wisdom-21-hint-1, eval = FALSE}
summary(...)
```

```{r wisdom-21-test, include = FALSE}
summary(x)
```

### 

We can see some information about our data. Most people have a family income between 20k and 30k. Most people are moderate in terms of political ideology. Most people strongly disapprove the president, the second biggest group for that variable is strongly approve. Most people only have a high school as their highest education.

### Exercise 22

Pipe `x` to `ggplot()` with `x` set to `ideology` and `fill` set to `approval`. Then add a layer of `geom_bar`.

```{r wisdom-22, exercise = TRUE}

```

```{r wisdom-22-hint-1, eval = FALSE}
x |>
  ggplot(aes(...)) +
  geom_bar()
```

```{r wisdom-22-test, include = FALSE}
x |>
  ggplot(aes(x = ideology, fill = approval)) +
  geom_bar()
```

### 

This graphs shows that most liberals strongly disapprove the 2020 president and most conservatives strongly support the 2020 president.

### Exercise 23

Improve your bar plot by adding a title, subtitle, axis labels, and a caption using `labs()`. This will make your plot easier to understand for readers.

```{r wisdom-23, exercise = TRUE}

```

<button onclick="transfer_code(this)">

Copy previous code

</button>

```{r wisdom-23-hint-1, eval = FALSE}
... +
  labs(title = "...",
       subtitle = "...",
       x = "...",
       y = "...",
       fill = "...",
       caption = "...")
```

```{r wisdom-23-test, include = FALSE}
x |>
  ggplot(aes(x = ideology, fill = approval)) +
  geom_bar() +
  labs(title = "Relationship Between President Approval and Political Ideology in 2020",
       subtitle = "Most people strongly disapprove.",
       x = "Political Ideology",
       y = "Count",
       fill = "Approval of the President",
       caption = "Data from CES.")
```

### 

The graph should look something like this:

```{r}
#| echo: false

x |>
  ggplot(aes(x = ideology, fill = approval)) +
  geom_bar() +
  labs(title = "Relationship Between President Approval and Political Ideology",
       subtitle = "Most people strongly disapprove.",
       x = "Political Ideology",
       y = "Count",
       fill = "Approval of the President",
       caption = "Data from CES.")
```

### Exercise 24

In `analysis.qmd`, add the code the previous exercise to add the graph in the file.

Render the file. In the Console, run:

```         
show_file("analysis.qmd", start = -5)
```

CP/CR.

```{r wisdom-24}
question_text(NULL,
	answer(NULL, correct = TRUE),
	allow_retry = TRUE,
	try_again_button = "Edit Answer",
	incorrect = NULL,
	rows = 3)
```

### 

This graph is useful but we still need to create an actual model with this data in order to answer our questions.

### Exercise 25

In your own words, define "validity" as we use the term.

```{r wisdom-25}
question_text(NULL,
	message = "Validity is the consistency, or lack thereof, in the columns of the data set and the corresponding columns in the Preceptor Table.",
	answer(NULL, correct = TRUE),
	allow_retry = FALSE,
	incorrect = NULL,
	rows = 6)
```

### 

Validity is always about the *columns* in the Preceptor Table and the data. Just because columns from these two different tables have the same *name* does not mean that they are the same *thing*.

### Exercise 26

Provide one reason why the assumption of validity might not hold for the outcome variable `approval` or for one of the covariates. Use the words "column" or "columns" in your answer.

```{r wisdom-26}
question_text(NULL,
	message = "Both the colums in the data we have and the Preceptor Table have a variable called approval, but the Preceptor Table is the true approval of the president where as the data only has the self reported approval of the president. People could lie about their approval of the president.",
	answer(NULL, correct = TRUE),
	allow_retry = FALSE,
	incorrect = NULL,
	rows = 6)
```

### 

In order to consider the Preceptor Table and the data to be drawn from the same population, the columns from one must have a *valid correspondence* with the columns in the other. Validity, if true (or at least reasonable), allows us to construct the Population Table, which is the first step in Justice.

Because we control the Preceptor Table and, to a lesser extent, the original question, we can adjust those variables to be “closer” to the data that we actually have. This is another example of the iterative nature of data science. If the data is not close enough to the question, then we check with our boss/colleague/customer to see if we can modify the question in order to make the match between the data and the Preceptor Table close enough for validity to hold.

Despite these potential problems, we will assume that validity holds since it, mostly (?), does.

### Exercise 27

Over the course of this tutorial, we will be creating a summary paragraph. The purpose of this exercise is to write the first two sentences of that paragraph.

The first sentence is a general statement about the overall topic, mentioning both the general class of the outcome variable and of at least one of the covariates. It is **not** connected to the initial "Imagine that you are XX" which set the stage for this project. That sentence can be rhetorical. It can be trite, or even a platitude. The purpose of the sentence is to let the reader know, gently, about our topic.

The second sentence does two things. First, it introduces the data source. Second, it introduces the specific question. The sentence can't be that long. Important aspects of the data include when/where it was gathered, how many observations it includes and the organization (if famous) which collected it.

Type your two sentences below.

```{r wisdom-27}
question_text(NULL,
	message = "Public opinion about political leaders often depends on where people fall on the ideological spectrum. Using data from the 2020 Cooperative Election Study, one of the largest political surveys in the U.S., we explore how presidential approval varies across different ideological groups.",
	answer(NULL, correct = TRUE),
	allow_retry = FALSE,
	incorrect = NULL,
	rows = 6)
```

### 

Read our answer. It will not be the same as yours. You can, if you want, change your answer to incorporate some of our ideas. Do not copy/paste our answer exactly. Add your two sentences, edited or otherwise, to your QMD, `Cmd/Ctrl + Shift + K`, and then commit/push.

## Justice
### 

*The arc of the moral universe is long, but it bends toward justice.* - Theodore Parker

### Exercise 1

In your own words, name the four key components of Justice for working on a data science problem.

```{r justice-1}
question_text(NULL,
	message = "Justice concerns four topics: the Population Table, stability, representativeness, and unconfoundedness.",
	answer(NULL, correct = TRUE),
	allow_retry = FALSE,
	incorrect = NULL,
	rows = 6)
```

### 

Justice is about concerns that you (or your critics) might have, reasons why the model you create might not work as well as you hope.

### Exercise 2

In your own words, define a Population Table.

```{r justice-2}
question_text(NULL,
	message = "The Population Table includes a row for each unit/time combination in the underlying population from which both the Preceptor Table and the data are drawn.",
	answer(NULL, correct = TRUE),
	allow_retry = FALSE,
	incorrect = NULL,
	rows = 6)
```

### 

The Population Table is almost always much bigger than the combination of the Preceptor Table and the data because, if we can really assume that both the Preceptor Table and the data are part of the same population, than that population must cover a broad universe of time and units since the Preceptor Table and the data are, themselves, often far apart from each other.
 

 ```{r}
 population_table <- tibble::tibble(
  unit = c("Person A", "Person B", "Person C", "Person D", "Person E"),
  ideology = c("Very Liberal", "Moderate", "Conservative", "Liberal", "Very Conservative"),
  education = c("College Graduate", "Some College", "High School", "Graduate Degree", "High School"),
  approval = c("Strongly Approve", "Neither Approve nor Disapprove", 
               "Disapprove / Somewhat Disapprove", "Approve / Somewhat Approve", "Strongly Disapprove")
)

population_table |>
  gt::gt() |>
  gt::tab_header(title = "Example Population Table")

 ```

### Exercise 3

In your own words, define the assumption of "stability" when employed in the context of data science.

```{r justice-3}
question_text(NULL,
	message = "Stability means that the relationship between the columns in the Population Table is the same for three categories of rows: the data, the Preceptor Table, and the larger population from which both are drawn.",
	answer(NULL, correct = TRUE),
	allow_retry = FALSE,
	incorrect = NULL,
	rows = 6)
```

### 

Stability is all about *time*. Is the relationship among the columns in the Population Table stable over time? In particular, is the relationship --- which is another way of saying "mathematical formula" --- at the time the data was gathered the same as the relationship at the (generally later) time references by the Preceptor Table.

### Exercise 4

Provide one reason why the assumption of stability might not be true in this case.

```{r justice-4}
question_text(NULL,
	message = "We are concerned about the year 2020 and the data we have has information for 2020, so their is no danger to stability. The time the data was gathered is the same as the time refered to in the Preceptor Table.",
	answer(NULL, correct = TRUE),
	allow_retry = FALSE,
	incorrect = NULL,
	rows = 6)
```

### 

A change in time or the distribution of the data does not, in and of itself, demonstrate a violation of stability. Stability is about the parameters: $\beta_0$, $\beta_1$ and so on. Stability means these parameters are the same in the data as they are in the population as they are in the Preceptor Table.

### Exercise 5

We use our data to make inferences about the overall population. We use information about the population to make inferences about the Preceptor Table: `Data -> Population -> Preceptor Table`. In your own words, define the assumption of "representativeness" when employed in the context of data science.

```{r justice-5}
question_text(NULL,
	message = "Representativeness, or the lack thereof, concerns two relationships among the rows in the Population Table. The first is between the data and the other rows. The second is between the other rows and the Preceptor Table.",
	answer(NULL, correct = TRUE),
	allow_retry = FALSE,
	incorrect = NULL,
	rows = 6)
```

### 

Ideally, we would like both the Preceptor Table *and* our data to be random samples from the population. Sadly, this is almost never the case.

### Exercise 6

We do not use the data, directly, to estimate missing values in the Preceptor Table. Instead, we use the data to learn about the overall population. Provide one reason, involving the relationship between the data and the population, for why the assumption of representativeness might not be true in this case.

```{r justice-6}
question_text(NULL,
	message = "A large portion of the CES respondents are YouGov panelists. This group might not representative of the whole population because they might be more politically active and care more about politics than other people do.",
	answer(NULL, correct = TRUE),
	allow_retry = FALSE,
	incorrect = NULL,
	rows = 6)
```

### 

The reason that representativeness is important is because, when it is violated, the estimates for the model parameters might be biased.

### Exercise 7

We use information about the population to make inferences about the Preceptor Table. Provide one reason, involving the relationship between the population and the Preceptor Table, for why the assumption of representativeness might not be true in this case.

```{r justice-7}
question_text(NULL,
	message = "Because the Preceptor Table includes the entire population, there is no problem with representativeness in using the population to draw inferences about the Precetor Table. They are one and the same.",
	answer(NULL, correct = TRUE),
	allow_retry = FALSE,
	incorrect = NULL,
	rows = 6)
```

### 

Stability looks across time periods. Representativeness looks within time periods, for the most part. 

### Exercise 8

In your own words, define the assumption of "unconfoundedness" when employed in the context of data science.

```{r justice-8}
question_text(NULL,
	message = "Unconfoundedness means that the treatment assignment is independent of the potential outcomes, when we condition on pre-treatment covariates.",
	answer(NULL, correct = TRUE),
	allow_retry = FALSE,
	incorrect = NULL,
	rows = 6)
```

### 

This assumption is only relevant for causal models. We describe a model as "confounded" if this is not true. The easiest way to ensure unconfoundedness is to assign treatment randomly.

### Exercise 9

Write one sentence which highlights a potential weakness in your model. This will almost always be derived from possible problems with the assumptions discussed above. We will add this sentence to our summary paragraph. So far, our version of the summary paragraph looks like this:

> Public opinion about political leaders often depends on where people fall on the ideological spectrum. Using data from the 2020 Cooperative Election Study, one of the largest political surveys in the U.S., we explore how presidential approval varies across different ideological groups.

Of course, your version will be somewhat different.

```{r justice-9}
question_text(NULL,
	message = "Public opinion about political leaders often depends on where people fall on the ideological spectrum. Using data from the 2020 Cooperative Election Study, one of the largest political surveys in the U.S., we explore how presidential approval varies across different ideological groups. One concern is that survey respondents might be systematically different from other Americans.",
	answer(NULL, correct = TRUE),
	allow_retry = FALSE,
	incorrect = NULL,
	rows = 6)
```

### 

Add a weakness sentence to the summary paragraph in your QMD. You can modify your paragraph as you see fit, but do not copy/paste our answer exactly. `Cmd/Ctrl + Shift + K`, and then commit/push.

## Courage
### 

*Courage is going from failure to failure without losing enthusiasm.* - Winston Churchill

### Exercise 1

In your own words, describe the components of the virtue of Courage for analyzing data.

```{r courage-1}
question_text(NULL,
	message = "Courage starts with math, explores models, and then creates the data generating mechanism.",
	answer(NULL, correct = TRUE),
	allow_retry = FALSE,
	incorrect = NULL,
	rows = 6)
```

###

The probability family is determined by the outcome variable $Y$. 

Since \$Y\$ is an ordinal variable (with 2+ ordered values), the probability family is Cumulative Logistic.

$$
\text{approval} \sim \text{CumulativeLogit}(\theta_1, \theta_2, \ldots, \theta_{K-1})
$$

where each \$\theta\_k\$ defines a threshold between approval levels, and the model estimates the probability of being at or below each category using a series of cumulative log-odds.

### Exercise 2

Load the [**broom**](https://broom.tidymodels.org/) package.

```{r courage-2, exercise = TRUE}

```

```{r courage-2-hint-1, eval = FALSE}
library(...)
```

```{r courage-2-test, include = FALSE}
library(broom)
```

### 

The link function, the basic mathematical structure of the model, is (mostly) determined by the type of outcome variable.

Since `approval` is an **ordinal** variable, we use a **cumulative logit model** (also called the proportional odds model):

$$
\log\left[ \frac{P(Y \leq k)}{P(Y > k)} \right] = \theta_k - (\beta_1 \cdot \text{ideology} + \beta_2 \cdot \text{education})
$$

The link functions for categorical and cumulative variables are also built out of a log-odds link functions.

### Exercise 3

Use AI to come up with a $\LaTeX$ representation of the mathematical structure of the model, with $Y$ as the dependent variable and $X_1$, $X_2$ and so on as the independent variables. This version will not have the values of any parameters since we have not, yet, estimated them. Confirm that the $\LaTeX$ code works by placing it in your QMD and then rendering. Paste that $\LaTeX$ code below.

```{r courage-3}
question_text(NULL,
	answer(NULL, correct = TRUE),
	allow_retry = TRUE,
	try_again_button = "Edit Answer",
	incorrect = NULL,
	rows = 5)
```

###

Our answer:

$$P(Y \leq k) = \frac{1}{1 + e^{-(\alpha_k - \beta_1 \cdot \text{ideology} - \beta_2 \cdot \text{education})}}$$

with $Y \sim \text{Ordinal}(\boldsymbol{\rho})$ where $\boldsymbol{\rho} = (\rho_1, \rho_2, \ldots, \rho_K)$ are derived from the cumulative probabilities above.

Which we created with $\LaTeX$ code that looks like this:

````
$$P(Y \leq k) = \frac{1}{1 + e^{-(\alpha_k - \beta_1 \cdot \text{ideology} - \beta_2 \cdot \text{education})}}$$

with $Y \sim \text{Ordinal}(\boldsymbol{\rho})$ where $\boldsymbol{\rho} = (\rho_1, \rho_2, \ldots, \rho_K)$ are derived from the cumulative probabilities above.
````
This follows the proportional odds model used for ordinal outcome variables. The thresholds $\alpha_k$ define the cutpoints between categories of approval, and the coefficients $\beta_1$ and $\beta_2$ represent how ideology and education affect the log-odds of being in category $k$ or below.

We use generic variables --- $Y$, $X_1$ and so on --- because our purpose is to describe the general mathematical structure of the model, independent of the specific variables we will eventually choose to use.

### Exercise 4

Add `library(broom)` to the `setup` code chunk in your QMD. `Cmd/Ctrl + Shift + K`.

At the Console, run:

```         
tutorial.helpers::show_file("analysis.qmd", pattern = "library")
```

CP/CR.

```{r courage-4}
question_text(NULL,
	answer(NULL, correct = TRUE),
	allow_retry = TRUE,
	try_again_button = "Edit Answer",
	incorrect = NULL,
	rows = 3)
```

### 

Having decided on the basic mathematical structure of the model, a choice mostly driven by the distribution of our outcome variable, we now turn toward estimating the model.

### Exercise 5

Because our outcome variable is **cumulative**, start to create the model by entering `multinom_reg(engine = "glmnet")`.

Your arguments to `MASS::polr()` should be `formula = approval ~ ideology + education` and `data = x`.

```{r courage-5, exercise = TRUE}

```

```{r courage-5-hint-1, eval = FALSE}
MASS::polr(formula = approval ~ ... + education,
    ... = x)
```

```{r courage-5-test, include = FALSE}
MASS::polr(formula = approval ~ ideology + education, data = x)

```

### 

We can’t use `tidymodels` here because it doesn’t currently support **ordinal regression models**, which we need since our outcome variable, `approval`, is ordinal (ordered categories). Instead, we use the `polr()` function from the **MASS** package, which is specifically designed for this type of model.

### Exercise 6

Behind the scenes, we have used `polr()` to create an object named `fit_approval`. This version was created using `x` so it has more rows than the one you created in the previous exercise.

Type `fit_approval` and hit "Run Code." This generates the same results as using `print(fit_approval)`.

```{r courage-6, exercise = TRUE}

```

```{r courage-6-hint-1, eval = FALSE}
fit_approval
```

```{r courage-6-test, include = FALSE}
fit_approval
```

### 

In data science, **we deal with words, math, and code, but the most important of these is code.** We created the mathematical structure of the model and then wrote a model formula in order to estimate the unknown parameters. 

### Exercise 7

Continue the pipe with `tidy(conf.int = TRUE)`.

```{r courage-7, exercise = TRUE}

```

```{r courage-7-hint-1, eval = FALSE}
... |>
tidy(conf.int = ...)
```

<!-- AT: When ever tidy() is run on this data set is either runs forever or returns an error. -->

### 

`tidy()` is part of the [**broom**](https://broom.tidymodels.org/) package, used to summarize information from a wide variety of models.

### Exercise 8

Load the **[easystats](https://easystats.github.io/easystats/)** package.

```{r courage-8, exercise = TRUE}

```

```{r courage-8-hint-1, eval = FALSE}
library(...)
```

```{r courage-8-test, include = FALSE}
library(easystats)
```

###

We don't add **easystats** to the QMD because we are only using it for an interactive check of our fitted model. However, the [easystats ecosystem](https://easystats.github.io/easystats/) has a variety of interesting functions and packages which you might want to explore.

### Exercise 9

In the Console, run `check_predictions(fit_approval)`. CP/CR.

```{r courage-9, exercise = TRUE}

```

```{r courage-9-hint-1, eval = FALSE}
check_predictions(...)
```

```{r courage-9-test, include = FALSE}
check_predictions(fit_approval)
```

###

```{r}
check_predictions(fit_approval)
```

The purpose of `check_predictions()` is to compare your actual data (in green) with data simulated from your fitted model — your data generating mechanism. If your DGM is reasonable, then simulated data shouldn't look too different from your observed data. It's okay for it not to match exactly, but it should fall within a plausible range. If it doesn’t, you may need to revisit your assumptions.

### Exercise 10

Ask AI to create $\LaTeX$ code for this model, including our variable names and estimates for all the coefficients. Because this is a fitted model, the dependent variable will have a "hat" and the formula will not include an error term. 

Add the code to your QMD. `Cmd/Ctrl + Shift + K`.

Make sure the resulting display looks good. For example, you don't want an absurd number of figures to the right of the decimal. If the model is too long, you will need to spread it across several lines. You may need to go back-and-forth with the AI a few times.

Once the $\LaTeX$ code looks good, paste it below.

```{r courage-10}
question_text(NULL,
	answer(NULL, correct = TRUE),
	allow_retry = TRUE,
	try_again_button = "Edit Answer",
	incorrect = NULL,
	rows = 3)
```

###

Our formula looks like:

$$
\begin{aligned}
\log\left[ \frac { P( \operatorname{approval}  \leq  \operatorname{Strongly\ Disapprove} ) }{ 1 - P( \operatorname{approval}  \leq  \operatorname{Strongly\ Disapprove} ) } \right] &= 2.26 + 0.61(\operatorname{ideology}{\operatorname{Liberal}}) + 2.4(\operatorname{ideology}{\operatorname{Moderate}}) + 4.46(\operatorname{ideology}{\operatorname{Conservative}}) + 5.45(\operatorname{ideology}{\operatorname{Very\ Conservative}}) - 0.1(\operatorname{education}{\operatorname{High\ School\ Graduate}}) - 0.31(\operatorname{education}{\operatorname{Some\ College}}) - 0.32(\operatorname{education}{\operatorname{2-Year}}) - 0.52(\operatorname{education}{\operatorname{4-Year}}) - 0.73(\operatorname{education}{\operatorname{Post-Grad}}) \
\log\left[ \frac { P( \operatorname{approval}  \leq  \operatorname{Disapprove\ /\ Somewhat\ Disapprove} ) }{ 1 - P( \operatorname{approval}  \leq  \operatorname{Disapprove\ /\ Somewhat\ Disapprove} ) } \right] &= 2.73 + 0.61(\operatorname{ideology}{\operatorname{Liberal}}) + 2.4(\operatorname{ideology}{\operatorname{Moderate}}) + 4.46(\operatorname{ideology}{\operatorname{Conservative}}) + 5.45(\operatorname{ideology}{\operatorname{Very\ Conservative}}) - 0.1(\operatorname{education}{\operatorname{High\ School\ Graduate}}) - 0.31(\operatorname{education}{\operatorname{Some\ College}}) - 0.32(\operatorname{education}{\operatorname{2-Year}}) - 0.52(\operatorname{education}{\operatorname{4-Year}}) - 0.73(\operatorname{education}{\operatorname{Post-Grad}}) \
\log\left[ \frac { P( \operatorname{approval}  \leq  \operatorname{Neither\ Approve\ nor\ Disapprove} ) }{ 1 - P( \operatorname{approval}  \leq  \operatorname{Neither\ Approve\ nor\ Disapprove} ) } \right] &= 2.82 + 0.61(\operatorname{ideology}{\operatorname{Liberal}}) + 2.4(\operatorname{ideology}{\operatorname{Moderate}}) + 4.46(\operatorname{ideology}{\operatorname{Conservative}}) + 5.45(\operatorname{ideology}{\operatorname{Very\ Conservative}}) - 0.1(\operatorname{education}{\operatorname{High\ School\ Graduate}}) - 0.31(\operatorname{education}{\operatorname{Some\ College}}) - 0.32(\operatorname{education}{\operatorname{2-Year}}) - 0.52(\operatorname{education}{\operatorname{4-Year}}) - 0.73(\operatorname{education}{\operatorname{Post-Grad}}) \
\log\left[ \frac { P( \operatorname{approval}  \leq  \operatorname{Approve\ /\ Somewhat\ Approve} ) }{ 1 - P( \operatorname{approval}  \leq  \operatorname{Approve\ /\ Somewhat\ Approve} ) } \right] &= 3.93 + 0.61(\operatorname{ideology}{\operatorname{Liberal}}) + 2.4(\operatorname{ideology}{\operatorname{Moderate}}) + 4.46(\operatorname{ideology}{\operatorname{Conservative}}) + 5.45(\operatorname{ideology}{\operatorname{Very\ Conservative}}) - 0.1(\operatorname{education}{\operatorname{High\ School\ Graduate}}) - 0.31(\operatorname{education}{\operatorname{Some\ College}}) - 0.32(\operatorname{education}{\operatorname{2-Year}}) - 0.52(\operatorname{education}{\operatorname{4-Year}}) - 0.73(\operatorname{education}{\operatorname{Post-Grad}})
\end{aligned}
$$

It was created with:

````
$$\begin{aligned}
\log\left[ \frac { P( \operatorname{approval}  \leq  \operatorname{Strongly\ Disapprove} ) }{ 1 - P( \operatorname{approval}  \leq  \operatorname{Strongly\ Disapprove} ) } \right] &= 2.26 + 0.61(\operatorname{ideology}_{\operatorname{Liberal}}) + 2.4(\operatorname{ideology}_{\operatorname{Moderate}}) + 4.46(\operatorname{ideology}_{\operatorname{Conservative}}) + 5.45(\operatorname{ideology}_{\operatorname{Very\ Conservative}}) - 0.1(\operatorname{education}_{\operatorname{High\ School\ Graduate}}) - 0.31(\operatorname{education}_{\operatorname{Some\ College}}) - 0.32(\operatorname{education}_{\operatorname{2-Year}}) - 0.52(\operatorname{education}_{\operatorname{4-Year}}) - 0.73(\operatorname{education}_{\operatorname{Post-Grad}}) \\
\log\left[ \frac { P( \operatorname{approval}  \leq  \operatorname{Disapprove\ /\ Somewhat\ Disapprove} ) }{ 1 - P( \operatorname{approval}  \leq  \operatorname{Disapprove\ /\ Somewhat\ Disapprove} ) } \right] &= 2.73 + 0.61(\operatorname{ideology}_{\operatorname{Liberal}}) + 2.4(\operatorname{ideology}_{\operatorname{Moderate}}) + 4.46(\operatorname{ideology}_{\operatorname{Conservative}}) + 5.45(\operatorname{ideology}_{\operatorname{Very\ Conservative}}) - 0.1(\operatorname{education}_{\operatorname{High\ School\ Graduate}}) - 0.31(\operatorname{education}_{\operatorname{Some\ College}}) - 0.32(\operatorname{education}_{\operatorname{2-Year}}) - 0.52(\operatorname{education}_{\operatorname{4-Year}}) - 0.73(\operatorname{education}_{\operatorname{Post-Grad}}) \\
\log\left[ \frac { P( \operatorname{approval}  \leq  \operatorname{Neither\ Approve\ nor\ Disapprove} ) }{ 1 - P( \operatorname{approval}  \leq  \operatorname{Neither\ Approve\ nor\ Disapprove} ) } \right] &= 2.82 + 0.61(\operatorname{ideology}_{\operatorname{Liberal}}) + 2.4(\operatorname{ideology}_{\operatorname{Moderate}}) + 4.46(\operatorname{ideology}_{\operatorname{Conservative}}) + 5.45(\operatorname{ideology}_{\operatorname{Very\ Conservative}}) - 0.1(\operatorname{education}_{\operatorname{High\ School\ Graduate}}) - 0.31(\operatorname{education}_{\operatorname{Some\ College}}) - 0.32(\operatorname{education}_{\operatorname{2-Year}}) - 0.52(\operatorname{education}_{\operatorname{4-Year}}) - 0.73(\operatorname{education}_{\operatorname{Post-Grad}}) \\
\log\left[ \frac { P( \operatorname{approval}  \leq  \operatorname{Approve\ /\ Somewhat\ Approve} ) }{ 1 - P( \operatorname{approval}  \leq  \operatorname{Approve\ /\ Somewhat\ Approve} ) } \right] &= 3.93 + 0.61(\operatorname{ideology}_{\operatorname{Liberal}}) + 2.4(\operatorname{ideology}_{\operatorname{Moderate}}) + 4.46(\operatorname{ideology}_{\operatorname{Conservative}}) + 5.45(\operatorname{ideology}_{\operatorname{Very\ Conservative}}) - 0.1(\operatorname{education}_{\operatorname{High\ School\ Graduate}}) - 0.31(\operatorname{education}_{\operatorname{Some\ College}}) - 0.32(\operatorname{education}_{\operatorname{2-Year}}) - 0.52(\operatorname{education}_{\operatorname{4-Year}}) - 0.73(\operatorname{education}_{\operatorname{Post-Grad}})
\end{aligned}$$
````

Note the differences. First, we have replaced the parameters with our best estimates. Second, we have dropped the error term because this is a formula for predicting the value for our outcome variable. Third, the left-hand side variable is $\widehat{\text{log odds}}$ instead of $\text{log odds}$ because this formula generates our estimated log odds of being at or below each approval level. A hat indicates an estimated value.

**This is our data generating mechanism.**

A data generating mechanism is just a formula, something which we can write down and implement with computer code.

### Exercise 11

Create a new code chunk in your QMD. Add a code chunk option: `#| cache: true`. Copy/paste the code from above for estimating the model into the code chunk, assigning the result to `fit_approval`. 

`Cmd/Ctrl + Shift + K`. It may take some time to render your QMD, depending on how complex your model is. But, by including `#| cache: true` you cause Quarto to cache the results of the chunk. The next time you render your QMD, as long as you have not changed the code, Quarto will just load up the saved fitted object.

At the Console, run:

```
tutorial.helpers::show_file("analysis.qmd", start = -8)
```

CP/CR.

```{r courage-11}
question_text(NULL,
	answer(NULL, correct = TRUE),
	allow_retry = TRUE,
	try_again_button = "Edit Answer",
	incorrect = NULL,
	rows = 8)
```

### 

To confirm, `Cmd/Ctrl + Shift + K` again. It should be quick.

### Exercise 12

Add `*_cache` to `.gitignore` file. Cached objects are often large. They don't belong on Github.

At the Console, run:

```
tutorial.helpers::show_file(".gitignore")
```

CP/CR.

```{r courage-12}
question_text(NULL,
	answer(NULL, correct = TRUE),
	allow_retry = TRUE,
	try_again_button = "Edit Answer",
	incorrect = NULL,
	rows = 6)
```

###

Because of the change in your `.gitignore` (assuming that you saved it), the cache directory should not appear in the Source Control panel because Git is ignoring it, as instructed. Commit and push. 

### Exercise 13

In the Console, run `tidy()` on `fit_approval` with the argument `conf.int` set equal to `TRUE`. The returns 95% intervals for all the parameters in our model. This takes a minute or two to run.

```{r courage-13, exercise = TRUE}

```

```{r courage-13-hint-1, eval = FALSE}
tidy(..., conf.int = ...)
```

<!-- AT: In the tutorial I got an error on this exercise: "object 'x' not found."  -->

### 

`tidy()` is part of the [**broom**](https://broom.tidymodels.org/) package, used to summarize information from a wide variety of models.

### Exercise 14

Create a new code chunk in your QMD. Ask AI to help you make a nice looking table from the tibble which is returned by `tidy()`. You don't have to include all the variables which `tidy()` produces. We often just show the estimate and the confidence intervals.

Insert that code into the QMD. 

`Cmd/Ctrl + Shift + K`. 

Make sure it works. You might need to add some new libraries, e.g., **[tinytable](https://vincentarelbundock.github.io/tinytable/)**, **[knitr](https://yihui.org/knitr/)**, **[gt](https://gt.rstudio.com/)**, **[kableExtra](https://haozhu233.github.io/kableExtra/)**, **[flextable](https://davidgohel.github.io/flextable/)**, **[modelsummary](https://modelsummary.com/)**, et cetera, to the `setup` code chunk, if you use any functions from these packages, all of which have strengths and weaknesses for making tables.

At the Console, run:

```
tutorial.helpers::show_file("analysis.qmd", chunk = "Last")
```

CP/CR.

```{r courage-14}
question_text(NULL,
	answer(NULL, correct = TRUE),
	allow_retry = TRUE,
	try_again_button = "Edit Answer",
	incorrect = NULL,
	rows = 12)
```

###

This is ours:

```{r}
tidy_approval |> 
  select(term, estimate, conf.low, conf.high) |> 
  gt() |> 
  cols_label(
    term = "Variable",
    estimate = "Estimate",
    conf.low = "Lower CI",
    conf.high = "Upper CI"
  )
```

The code we used:

```
tidy_approval |> 
  select(term, estimate, conf.low, conf.high) |> 
  gt() |> 
  cols_label(
    term = "Variable",
    estimate = "Estimate",
    conf.low = "Lower CI",
    conf.high = "Upper CI"
  )
```

At the very least, your table should include a title and a caption with the data source. The more you use AI, the better you will get at doing so.

### Exercise 15

Add a sentence to your project summary.

Explain the structure of the model. Something like: "I/we model Y [the concept of the outcome, not the variable name] as a [linear/logistic/multinomial/ordinal] function of X [and maybe other covariates]."

Recall the beginning of our version of the summary:

> Public opinion about political leaders often depends on where people fall on the ideological spectrum. Using data from the 2020 Cooperative Election Study, one of the largest political surveys in the U.S., we explore how presidential approval varies across different ideological groups. One concern is that survey respondents might be systematically different from other Americans.

```{r courage-15}
question_text(NULL,
	message = "Public opinion about political leaders often depends on where people fall on the ideological spectrum. Using data from the 2020 Cooperative Election Study, one of the largest political surveys in the U.S., we explore how presidential approval varies across different ideological groups. One concern is that survey respondents might be systematically different from other Americans. We are using a cumulative model for ordinal regression.",
	answer(NULL, correct = TRUE),
	allow_retry = FALSE,
	incorrect = NULL,
	rows = 6)
```

### 

Read our answer. It will not be the same as yours. You can, if you want, change your answer to incorporate some of our ideas. Do not copy/paste our answer exactly. Add your two sentences, edited or otherwise, to the summary paragraph portion of your QMD. `Cmd/Ctrl + Shift + K`, and then commit/push.

## Temperance
### 

*Temperance is the greatest of all virtues. It subdues every passion and emotion, and almost creates a Heaven upon Earth.* - Joseph Smith Jr.

### Exercise 1

In your own words, describe the use of Temperance in data science.

```{r temperance-1}
question_text(NULL,
	message = "Temperance uses the data generating mechanism to answer the questions with which we began. Humility reminds us that this answer is always a lie. We can also use the DGM to calculate many similar quantities of interest, displaying the results graphically.",
	answer(NULL, correct = TRUE),
	allow_retry = FALSE,
	incorrect = NULL,
	rows = 6)
```

### 

Courage gave us the data generating mechanism. Temperance guides us in the use of the DGM — or the “model” — we have created to answer the questions with which we began. We create posteriors for the quantities of interest.

### Exercise 2

Before using the DGM, we should make sure that we can interpret it.

Recall the values for the parameters in our data generating mechanism:

```{r}
tidy_approval |> 
  select(term, estimate, conf.low, conf.high)
```

What does the "Very Conservative" coefficient tell us?

```{r temperance-2}
question_text(NULL,
	message = "The coefficient for 'ideologyVery Conservative' is negative, indicating that, when comparing Very Conservative respondents to the baseline (Moderates), the predicted approval rating is lower, adjusting for education.",
	answer(NULL, correct = TRUE),
	allow_retry = FALSE,
	incorrect = NULL,
	rows = 6)
```

### Exercise 3

What does the "College Graduate" coefficient tell us?

```{r temperance-3}
question_text(NULL,
	message = "The estimate for 'educationCollege Graduate' is negative, showing that College Graduates tend to have lower presidential approval compared to High School graduates (the baseline), adjusting for ideology.",
	answer(NULL, correct = TRUE),
	allow_retry = FALSE,
	incorrect = NULL,
	rows = 6)
```

### Exercise 4

Does the "Liberal" confidence interval include zero? What does that mean?

```{r temperance-4}
question_text(NULL,
	message = "The confidence interval for 'ideologyLiberal' does not include zero, so we can be confident that Liberals differ in approval compared to Moderates, after adjusting for education.",
	answer(NULL, correct = TRUE),
	allow_retry = FALSE,
	incorrect = NULL,
	rows = 6)
```

### Exercise 5

In the end, we don't really care about parameters, much less how to interpret them. Parameters are *imaginary*, like unicorns. We care about answers to our questions. Parameters are tools for answering questions. They aren't interesting in-and-of themselves. *In the modern world, all parameters are nuisance parameters.* 

Load the [**marginaleffects**](https://marginaleffects.com/) package.

```{r temperance-5, exercise = TRUE}

```

```{r temperance-5-hint-1, eval = FALSE}
library(...)
```

```{r temperance-5-test, include = FALSE}
library(marginaleffects)
```

### 

We should be modest in the claims we make. The posteriors we create are never the “truth.” The assumptions we made to create the model are never perfect. Yet decisions made with flawed posteriors are almost always better than decisions made without them.

### Exercise 6

What is the specific question we are trying to answer? 

```{r temperance-6}
question_text(NULL,
	message = "The general question: What is the relationship between the approval of the president and an individual's ideology? The specific question: What is the average difference in presidential approval between Very Liberal and Very Conservative people?",
	answer(NULL, correct = TRUE),
	allow_retry = FALSE,
	incorrect = NULL,
	rows = 6)
```

### 

Data science projects almost always begin with a broad topic of interest. Yet, in order to make progress, we need to drill down to a specific question. This leads to the creation of a data generating mechanism, which can now be used to answer lots of questions, thus allowing us to explore the original topic more broadly.

### Exercise 7

Run `predictions()` with `fit_approval` as the first argument and `condition = "ideology"` as the second. Note that this may take a minute or two to run.

```{r temperance-7, exercise = TRUE}

```

```{r temperance-7-hint-1, eval = FALSE}
predictions(fit_approval, condition = "ideology")
```

<!-- This function takes too long to run for us to test it here.  -->

### 

`predictions()` returns predicted probabilities for each observation, showing how the model expects the outcome (approval) to vary by ideology. This helps visualize model fit across groups.

### Exercise 8

Run `comparisons()` with `fit_approval` as the first argument and `variable = "ideology"` as the second. Note that this may take a minute or two to run.

```{r temperance-8, exercise = TRUE}

```

```{r temperance-8-hint-1, eval = FALSE}
comparisons(fit_approval, variable = "ideology")
```

<!-- This function takes too long to run for us to test it here.  -->

### 

`comparisons()` calculates the differences in predicted approval between ideology groups. It quantifies how much approval varies when moving from one ideology to another.

### Exercise 9

Run the `avg_comparisons()` function with `fit_approval` as the first argument and `variable = "ideology"` as the second.

```{r temperance-9, exercise = TRUE}

```

```{r temperance-9-hint-1, eval = FALSE}
avg_comparisons(fit_approval, variable = "ideology")
```

```{r temperance-9-test, include = FALSE}
avg_comparisons(fit_approval, variable = "ideology")
```

### 

`avg_comparisons()` summarizes average differences across all observations, giving an overall estimate of the typical change in approval between ideologies, adjusting for other variables.

### Exercise 10

Run the `predictions()` function with `fit_approval` as the first argument and `condition = "ideology"` as the second.

```{r temperance-10, exercise = TRUE}

```

```{r temperance-10-hint-1, eval = FALSE}
plot_predictions(fit_approval, condition = "ideology")
```

```{r temperance-10-test, include = FALSE}
plot_predictions(fit_approval, condition = "ideology")
```

### 

`plot_predictions()` creates a visual representation of predicted approval probabilities by ideology, allowing quick comparison of group-level differences and uncertainty.

### Exercise 11

Run this code:

```
plot_predictions(fit_approval, 
                 condition = c("ideology", "education"))
```       

```{r temperance-11, exercise = TRUE}

```

```{r temperance-11-test, include = FALSE}

```

### 

This plot shows predicted presidential approval probabilities broken down by political ideology and education level. It reveals that approval is generally higher among more conservative groups and tends to increase with higher education levels. The variation across education within each ideology group highlights the nuanced differences in approval ratings, helping us understand how these two factors jointly influence voter attitudes.

### Exercise 12

Work interactively with your QMD to make a beautiful version of this plot. Your title should highlight the key variables. Your subtitle should describe the key takeaway, the sentence/conclusion which readers will, you hope, remember. Your caption should mention the data source. Your axis labels should look nice.

This plot is not directly connected to your question. It answers lots of questions! It might be used by lots of different people. 

Copy the code for your plot here:

```{r temperance-12}
question_text(NULL,
	answer(NULL, correct = TRUE),
	allow_retry = TRUE,
	try_again_button = "Edit Answer",
	incorrect = NULL,
	rows = 20)
```

###

Data science often involves this-back-and-forth style of work. First, we need to make a single chunk of code, in this case, a new plot, work well. This requires interactive work between the QMD and the Console. Second, we need to ensure that the entire QMD runs correctly on its own.

### Exercise 13

Finalize the new graphics code chunk in your QMD.

`Cmd/Ctrl + Shift + K` to ensure that it all works as intended. Don't forget to add `library(marginaleffects)` to your `setup` code chunk.

At the Console, run:

```
tutorial.helpers::show_file("analysis.qmd", start = -8)
```

CP/CR.

```{r temperance-13}
question_text(NULL,
	answer(NULL, correct = TRUE),
	allow_retry = TRUE,
	try_again_button = "Edit Answer",
	incorrect = NULL,
	rows = 10)
```


### 

Always [remember](https://en.wikipedia.org/wiki/Map%E2%80%93territory_relation): *The map is not the territory.* A beautiful graphic tells a story, but that story is always an imperfect representation of reality. Our models depend on assumptions, assumptions which are never completely true.

### Exercise 14

Write the last sentence of your summary paragraph. It describes at least one quantity of interest (QoI) and provides a measure of uncertainty about that QoI. (It is OK if this QoI is not the one that you began with. The focus of a data science project often changes over time.)

```{r temperance-14}
question_text(NULL,
	message = "Public opinion about political leaders often depends on where people fall on the ideological spectrum. Using data from the 2020 Cooperative Election Study, one of the largest political surveys in the U.S., we explore how presidential approval varies across different ideological groups. One concern is that survey respondents might be systematically different from other Americans. We are using a cumulative model for ordinal regression. People who are very conservative are more likely to approve the president higher by about 5.6 compared to people who are very liberal. We are 95% confident that the true value is between 4.9 and 6.2.",
	answer(NULL, correct = TRUE),
	allow_retry = FALSE,
	incorrect = NULL,
	rows = 6)
```

### 

Add a final sentence to your summary paragraph in your QMD as you see fit, but do not copy/paste our answer exactly. `Cmd/Ctrl + Shift + K`.

### Exercise 15

Write a few sentences which explain why the estimates for the quantities of interest, and the uncertainty thereof, might be wrong. Suggest an alternative estimate and confidence interval, if you think either might be warranted.

```{r temperance-15}
question_text(NULL,
	message = "Our estimates and confidence intervals might not be wrong because the data is not perfect. We have noticed some potential problems such as in validity; people could be lying about thier approval of the president or misidentifying their ideology. These concerns can cause our findings to be inaccurate. The true estimate and confidence interval might be different. The interval would be bigger because we have uncertainties about the data.",
	answer(NULL, correct = TRUE),
	allow_retry = FALSE,
	incorrect = NULL,
	rows = 6)
```

### 

Always go back to your Preceptor Table, the information which, if you had it, would make answering your question easy. In almost all real world cases, the Preceptor Table and the data are fairly different, not least because validity never holds perfectly. So, even a perfectly estimated statistical model is rarely as useful as we might like.

### Exercise 16

Rearrange the material in your QMD so that the order is graphic, followed by the paragraph. Doing so, of course, requires sensible judgment. For example, the code chunk which creates the fitted model must occur before the chunk which creates the graphic. You can keep or discard the math and any other material at your own discretion.

`Cmd/Ctrl + Shift + K` to ensure that everything works.

At the Console, run:

```
tutorial.helpers::show_file("analysis.qmd")
```

CP/CR.

```{r temperance-16}
question_text(NULL,
	answer(NULL, correct = TRUE),
	allow_retry = TRUE,
	try_again_button = "Edit Answer",
	incorrect = NULL,
	rows = 30)
```

### 

This is the version of your QMD file which your teacher is most likely to take a close look at.

### Exercise 17

Publish your rendered QMD to GitHub Pages. Copy/paste the resulting url below.

```{r temperance-17}
question_text(NULL,
	answer(NULL, correct = TRUE),
	allow_retry = TRUE,
	try_again_button = "Edit Answer",
	incorrect = NULL,
	rows = 3)
```

### 

Commit/push everything.

### Exercise 18

Copy/paste the url to your Github repo.

```{r temperance-18}
question_text(NULL,
	answer(NULL, correct = TRUE),
	allow_retry = TRUE,
	try_again_button = "Edit Answer",
	incorrect = NULL,
	rows = 3)
```

### 

We can never know all the entries in the Preceptor Table. That knowledge is reserved for God. If all our assumptions are correct, then our DGM is true, it accurately describes the way in which the world works. There is no better way to predict the future, or to model the past, than to use it. Sadly, this will only be the case with toy examples involving things like coins and dice. We hope that our DGM is close to the true DGM but, since our assumptions are never perfectly correct, our DGM will always be different. The estimated magnitude and importance of that difference is a matter of judgment.

The world confronts us. Make decisions we must.

## Summary
### 

This tutorial covered topics related to [*Preceptor’s Primer for Bayesian Data Science: Using the Cardinal Virtues for Inference*](https://ppbds.github.io/primer/) by [David Kane](https://davidkane.info/).

```{r}
plot_predictions(fit_approval, 
                 condition = c("ideology", "education")) +
  labs(
    title = "Presidential Approval by Ideology and Education",
    subtitle = "Approval decreases with conservative ideology; education slightly moderates this pattern",
    x = "Ideology",
    y = "Predicted Probability of Approval",
    color = "Education",
    shape = "Education"
  ) +
  theme_minimal()
```

This tutorial explored patterns in presidential approval using an ordinal outcome variable and categorical predictors like ideology and education. Using data from the 2020 Cooperative Election Study, we found that approval levels decrease as individuals become more conservative, and that education slightly shifts these approval levels. This insight could help our pollster better target voter outreach or refine survey sampling strategies by accounting for both political ideology and educational background.

```{r download-answers, child = system.file("child_documents/download_answers.Rmd", package = "tutorial.helpers")}
```
