---
title: 'Wrangling: Plots'
author: Atilla Colak
tutorial:
  id: wrangling-plots
output:
  learnr::tutorial:
    progressive: yes
    allow_skip: yes
runtime: shiny_prerendered
description: Complex pipes leading to plots.
---

<!-- The below links should be dropped at least once, if not twice. -->

<!-- https://ggplot2.tidyverse.org/ -->
<!-- https://ggplot2-book.org/ -->
<!-- https://socviz.co/ -->
<!-- https://clauswilke.com/dataviz/ -->


```{r setup, include = FALSE}
library(learnr)
library(primer.tutorials)
library(tidyverse)
library(lubridate)
library(janitor)
library(stringr)
library(skimr)
library(primer.data)
library(babynames)
library(ggdist)
library(plotly)
library(dplyr)
library(gghighlight)
library(scales)
library(ggalt)

knitr::opts_chunk$set(echo = FALSE)
options(tutorial.exercise.timelimit = 60, 
        tutorial.storage = "local") 

# Needed for later sections of the tutorial 

library(ggthemes)

covid <- read_csv('data/owid-covid-data.csv')
income <- read_csv("data/inc_occ_gender.csv", show_col_types = FALSE) 
names(income) <- tolower(names(income))
```

```{r copy-code-chunk, child = "../../child_documents/copy_button.Rmd"}
```

```{r info-section, child = "../../child_documents/info_section.Rmd"}
```

## National Health and Nutrition Survey

### 

National Health and Nutrition Examination Survey (NHANES) is a survey distributed to adults and children in the United States. 


### 

Let's create the following plot.

```{r}
nhanes_p <- nhanes %>%
  mutate(weight = weight * 2.2, height = height / 30.48) %>%
  select(gender, weight, height, bmi) %>%
  drop_na(weight, height) %>% 
  ggplot(mapping = aes(x = weight, y = height, color = bmi)) +
    geom_jitter() +
    geom_smooth(se = FALSE, 
                method = "loess", 
                formula = y ~ x) +
    facet_wrap(~ gender) + 
    theme_clean() + 
    labs(y = "Height (feet)",
         x = "Weight (pounds)",
         title = "Height Versus Weight in the US",
         subtitle = "Association between weight and height is more positive for heavy men",
         color = "BMI",
         caption = "Source: NHANES (National Health and Examination Survey)")

nhanes_p
```

### Exercise 1

To view all columns and some of the respective values, `glimpse()` the `nhanes` data set.

```{r national-health-and--1, exercise = TRUE}

```

```{r national-health-and--1-hint-1, eval = FALSE}
glimpse(...)
```

### 

`nhanes` includes data from the "National Health and Nutrition Examination Survey," which contains the personal and physical information of 10,000 Americans from two surveys in 2009 and 2011.

### Exercise 2

In the tibble above, `weight` and `height` is measured in kg and cm, respectively. Using `mutate()`, multiply `weight` by 2.2 and divide `height` by 30.48 to convert units into pounds and feet. 

```{r national-health-and--2, exercise = TRUE}

```

```{r national-health-and--2-hint-1, eval = FALSE}
nhanes %>%
  mutate(weight = ..., 
         height = ...)
```

```{r national-health-and--2-hint-2, eval = FALSE}
Use * to multiply and / to divide.
```

```{r national-health-and--2-hint-3, eval = FALSE}
nhanes %>%
  mutate(weight = ... * ..., 
         height = ... / ...)
```

### Exercise 3

Now `select()` the `gender`, `weight`, `height`, and `bmi` columns. 

```{r national-health-and--3, exercise = TRUE}

```

<button onclick = "transfer_code(this)">Copy previous code</button>

```{r national-health-and--3-hint-1, eval = FALSE}
... %>%
  select(..., ..., ..., ...)
```

### 

There are a variety of "[selection helper](https://tidyselect.r-lib.org/reference/select_helpers.html)" functions which one can use with `select()`. One of them, `matches()`, allows us to do pattern matching. So, for example, `select(matches("^.ei"), gender, bmi)` would select the same four columns as we do here because the only variables with an "e" as the second character and an "i" as the third character are `weight` and `height`.

### Exercise 4

`nhanes` contains NA values in some rows. Start a pipe with `nhanes`. Use `drop_na()` with the arguments `weight`and `height` to remove all rows with NA value in these columns.

```{r national-health-and--4, exercise = TRUE}

```

<button onclick = "transfer_code(this)">Copy previous code</button>

```{r national-health-and--4-hint-1, eval = FALSE}
... %>%
  drop_na(..., ...)
```

### 

For some cases, there are columns where more than 60% of data is NA. In those cases, we would consider dropping the column. 

### Exercise 5

Continue your pipe with `ggplot()`. Furthermore, add the layer `geom_jitter()` to make a jittered scatterplot. Map `weight` to the x-axis, `height` to the y-axis, and `bmi` to `color`.

```{r national-health-and--5, exercise = TRUE}

```

<button onclick = "transfer_code(this)">Copy previous code</button>

```{r national-health-and--5-hint-1, eval = FALSE}
... %>% 
  ggplot(data = ..., aes(x = ..., 
                        y = ..., 
                        color = ...)) +
  geom_jitter()
```

### 

Instead of `geom_jitter()`, we also can use `geom_pointdensity()` function from **[ggpointdensity](https://github.com/LKremer/ggpointdensity)** package, which would color datapoints by how often they appear. 

### Exercise 6

A trend line will help you visualize the general association between variables. Add one with the layer `geom_smooth()`. Set the argument `se` to FALSE and set `method` to "loess".

```{r national-health-and--6, exercise = TRUE}

```

<button onclick = "transfer_code(this)">Copy previous code</button>

```{r national-health-and--6-hint-1, eval = FALSE}
... + 
  geom_smooth(se = ..., method = ...)
```

### 

`se` argument specifies whether the confidence interval should be displayed. If `se` is true, which is the default setting, we should also specify the `level` argument. `level` specifices the confidence level of the interval, 0.95 by default.

### Exercise 7

Notice the raised message. Within `geom_smooth()` set the `formula` argument to `y ~ x` , which will make it disappear.

```{r national-health-and--7, exercise = TRUE}

```

<button onclick = "transfer_code(this)">Copy previous code</button>

```{r national-health-and--7-hint-1, eval = FALSE}
... + 
 geom_smooth(se = FALSE, 
             method = "loess", 
             formula = ...)
```

### 

Although there is no warning, the output smoothed line is the same as before. This is because the reason of the warning is to remind us that we should specify the formula, even though by default ggplot uses `y ~ x` formula.

### Exercise 8

It's more insightful to separate the plot by gender , the process known as *faceting*, and displaying data of both genders as individual plots. Use `facet_wrap()` to facet the graph by `gender`.

```{r national-health-and--8, exercise = TRUE}

```

<button onclick = "transfer_code(this)">Copy previous code</button>

```{r national-health-and--8-hint-1, eval = FALSE}
... +
  facet_wrap( ~ ...) 
```

### 

In some cases, such as the case of graphing by one variable, we can use `facet_wrap()` and `facet_grid()` interchangeably. However, in general, the use of these two functions is different. `facet_grid()` produces a 2d grid of panels defined by variables, whereas `facet_wrap()` "wraps a 1d ribbon of panels into 2d. To learn more about this issue see [this thread](https://stackoverflow.com/questions/20457905/whats-the-difference-between-facet-wrap-and-facet-grid-in-ggplot2).

### Exercise 9

Adjust the theme of the graph. For a simplistic and clean theme, add `theme_clean()`.

```{r national-health-and--9, exercise = TRUE}

```

<button onclick = "transfer_code(this)">Copy previous code</button>

```{r national-health-and--9-hint-1, eval = FALSE}
Recall that when you add a theme, you add a layer! Use the + operator.
```

```{r national-health-and--9-hint-2, eval = FALSE}
... +
  theme_clean()
```

### 

Alternatively, we also can use similar themes such as `theme_light()` and `theme_classic()`.

### Exercise 10

To finish your plot, use `labs()` to give the graph a title, subtitle, axis labels, legend labels, and caption of your choice.

```{r national-health-and--10, exercise = TRUE}

```

Reminder: This is what your plot should look like.

```{r nhanes10-answer}
nhanes_p
```

## Covid-19

### 

The `covid` contains data about Covid-19 and factors affecting Covid-19. Source of this data set is [Johns Hopkins University], and we downloaded it from [ourworldindata.org](https://ourworldindata.org/coronavirus-source-data).  


### 

Total Covid-19 cases over population proportion may be affected by ages of a country's residents, since Covid-19 has proven to be more infectious for elderly. 

### 

If we look at this plot, we can see that there is roughly a positive association between median age and total Covid-19 cases over population proportion.

Let's create this plot.


```{r covid}
covid_graph <- covid %>%
  select(continent, median_age, new_cases, location, population) %>%
  drop_na(new_cases) %>% 
  group_by(location) %>% 
  filter(continent != 'World') %>%
  summarize(case_by_pop = sum(new_cases) / first(population),
            agemed = first(median_age),
            continent = first(continent), 
            rm.na = TRUE,
            .group = 'drop') %>%
  ggplot(mapping = aes(x = agemed, 
                       y = case_by_pop,
                       label = location,
                       color = continent)) +
    geom_point() + 
    theme_economist() +
    labs(x = "Median Age",
         y = "Total Covid-19 cases over population ",
         title = "Relation of Covid-19 cases and median age")
    
final_graph <-  ggplotly(covid_graph)

final_graph
```

### Exercise 1

`glimpse()` the `covid` data set. 

```{r covid19-1, exercise = TRUE}

```

```{r covid19-1-hint-1, eval = FALSE}
glimpse(...)
```

### 

Although there are many NA values, these exist because of there isn't any of that variable. For example, for Covid-19 cases, there are NA values at the beginning since Covid-19 had not reached Afghanistan back then.

### Exercise 2

`select()` the `continent`, `location`, `new_cases`, and `median_age` variables.

```{r covid19-2, exercise = TRUE}

```

```{r covid19-2-hint-1, eval = FALSE}
covid %>%
  select(..., ..., ..., ...))
```

### 

Alternatively, we could use `ends_with` helper to select columns that ends with a certain suffix. For example, in this case,  we could use the following code: 
`select(ends_with(c("ent","cation","new_cases","median_age")))`.
Although this code would be inefficient in for this variables, it would be helpful if we were to select all `cases` related columns, all of which would end with `_cases`. 

### Exercise 3

Because we do not want to include rows where there are no Covid-19 cases, drop NA values in the `new_cases` column. 

```{r covid19-3, exercise = TRUE}

```

<button onclick = "transfer_code(this)">Copy previous code</button>

```{r covid19-3-hint-1, eval = FALSE}
... %>% 
  drop_na(...)
```

### 

If we did not `drop_na()`, errors would have been raised in further codes. 

### Exercise 4

To make our further country-based calculations easer, Now group by `location`.

```{r covid19-4, exercise = TRUE}

```

<button onclick = "transfer_code(this)">Copy previous code</button>

```{r covid19-4-hint-1, eval = FALSE}
... %>%
  group_by(...)
```

### 

In our dataset, there is a continent value `world` that contains the summation of data of individual countries. For example, new cases of `world` is the total new cases recorded that day. 

### Exercise 5

`filter` in a way that we extract all rows but the ones where the continent is `world`.

```{r covid19-5, exercise = TRUE}

```

<button onclick = "transfer_code(this)">Copy previous code</button>

```{r covid19-5-hint-1, eval = FALSE}
... %>%
  filter(...)
```

```{r covid19-5-hint-2, eval = FALSE}
To exclude a value, use `!=`.
```

### 

Because `world` is not  a continent and we want to make country-wise and country-wise analysis, we excluded the rows where the continent is equal to world.

### Exercise 6

For our analysis, we want to calculate total Covid-19 cases divided by population for each country. To achieve, we need to create a variable using `summarize`

### 

Create a variable `case_by_pop` that is equal to `sum()` of `new_cases` divided by population. 
Since the population is the same for every row for a country, to get the population, choose the `first()` value.

### 

Using the `first()` function, create a "agemed" and "continent" variables that should be equal to median age and continent of the country, respectively.

### 

Furthermore, to avoid any errors NA values might cause, set `na.rm` argument to `TRUE`.

```{r covid19-6, exercise = TRUE}

```

<button onclick = "transfer_code(this)">Copy previous code</button>

```{r covid19-6-hint-1, eval = FALSE}
... %>%
      summarize(case_by_pop = sum(...) / first(...),
              agemed = first(...),
              continent = first(...),
              na.rm = ...)
```

### 

Did you receive a warning message? 

### Exercise 7

Our job with groups is done since we have created the needed variables. However, we have to set an argument to choose what to do with groups. 

### 

`.groups` is an argument that tells `summarize()` what to do with the grouping of the data after it has used the grouping to produce its summary. 

If you exclude `groups` argument, you will get a warning message.

### 

within `summarize` function from previous exercise, set `.group` argument equal to "drop". 


```{r covid19-7, exercise = TRUE}

```

<button onclick = "transfer_code(this)">Copy previous code</button>

```{r covid19-7-hint-1, eval = FALSE}
... %>% 
  summarize(...,
            .groups = "...")
```

### 

 `.groups` does not affect the data in the summary tibble. You can either `"keep"` the grouping, `"drop"` the grouping, or `"drop_last"`, i.e. to drop the last of the specified grouping variables (this is because retaining all the same groups after summary creates groups which only contain single rows). `"drop_last"` is the default in most cases.  

### Exercise 8

To include all four variables on the plot, we have to map each of them to a different argument.

### 

Continue your pipe and add  `ggplot()`.  Map `agemed` to the x-axis, `case_by_pop` to the y-axis, `location` to the label, and `continent` to color.

Then, to create a scatter, add a new layer `geom_point()`.

```{r covid19-8, exercise = TRUE}

```

<button onclick = "transfer_code(this)">Copy previous code</button>

```{r covid19-8-hint-1, eval = FALSE}
... %>% 
  ggplot(mapping = aes(x = ..., 
                       y = ...,
                       label = ...,
                       location = ...) +
  geom_point()
```

### Exercise 9

Add the theme `theme_economist()` as a new layer to the plot.

```{r covid19-9, exercise = TRUE}

```

<button onclick = "transfer_code(this)">Copy previous code</button>

```{r covid19-9-hint-1, eval = FALSE}
... +
  theme_economist()
```

### 

Instead of `theme_economist()` we could have chosen a theme among choices such as `theme_minimal()`, `theme_classic()`, and many more. For all existing `ggplot2` themes, click [this link](https://ggplot2.tidyverse.org/reference/ggtheme.html).

### Exercise 10

To finish your plot, use `labs()` to give the graph a title and axis labels.

Reminder: This is what your plot should look like.

```{r covid19-10}
final_graph
```

```{r covid-10, exercise = TRUE}

```

<button onclick = "transfer_code(this)">Copy previous code</button>

### 

Now, although our graph looks like the desired graph, it is not interactive, and unlike expected, nothing happens if you hover your mouse over the plot.

This is beacuse, we have to make use of **[plotly](https://plotly.com/r/getting-started/)** package to create interactive graphs.

### Exercise 11

Moreover, to use plotly, we have to save our graph to a variable. Therefore, save our plot to a variable names `covid_graph`.

```{r covid19-11, exercise = TRUE}

```

<button onclick = "transfer_code(this)">Copy previous code</button>

```{r covid19-11-hint-1, eval = FALSE}
covid_graph <- covid %>%
  select(continent, median_age, new_cases, location, population) ...
.
.
.
```

### 

Since we saved our graph as `covid_graph`, the only thing to do is pass our variable as an argument to `ggplotly` function.

### Exercise 12

```{r covid19-12, exercise = TRUE}

```

<button onclick = "transfer_code(this)">Copy previous code</button>

```{r covid19-12-hint-1, eval = FALSE}
...

ggplotly(...)
```

### 

Well done!


## Seguro Popular

### 

The `sps` data set contains information about a study done on a popular Mexican health insurance program, Seguro Popular. In the study, some Mexican health clusters were randomly "treated." The treatment consisted of encouragement for people in that health cluster to enroll in the health insurance program, as well as funds to improve health facilities in that cluster.

### 

Let's create the following plot.

```{r sps_plot}
 
sps_p <- sps %>%
  filter(education %in% c("college", "high school", "secondary", "preschool")) %>%
  select(-c(health_exp_1m, t2_health_exp_1m)) %>%
  mutate(change_in_expenses = t2_health_exp_3m - health_exp_3m) %>%
  group_by(treatment, education) %>%
  summarize(mean_change_in_expenses = mean(change_in_expenses),
            .groups = "drop") %>%
  mutate(treatment = ifelse(treatment == "1", "Treatment Group", "Control Group")) %>%
  ggplot(mapping = aes(x = education, 
                       y = mean_change_in_expenses, 
                       fill = treatment)) +
    scale_fill_manual(values = c("cornflowerblue", "darkturquoise")) +
    geom_col(position = "dodge", alpha = 0.9) + 
    scale_x_discrete(limits = c("preschool", "secondary", "high school", "college")) +
    scale_y_continuous(labels = dollar_format(suffix = "₱", prefix = "")) +
    theme_minimal() +
    labs(x = "Education",
         y = "Average Change in Health Expenses",
         title = "Spending Changes and Seguro Popular",
         subtitle = "Treatment at college level reduced expenses the most",
         fill = "Treatment",
         caption = "Source: King et al. (2009)")

sps_p
```

### Exercise 1

`glimpse()` the dataset `sps`.

```{r seguro-popular-1, exercise = TRUE}

```

```{r seguro-popular-1-hint-1, eval = FALSE}
glimpse(...)
```

### 

The survey was conducted in two different periods of times. Initial period was for applying treatment to treatment group. The second period was for observing treatment results.



### Exercise 2

`filter()` `sps` to extract only the rows with an `education` level of `preschool`, `secondary`, `high school`, and `college`. 
Use the `%in%` to accelerate the process. 

```{r seguro-popular-2, exercise = TRUE}

```

<button onclick = "transfer_code(this)">Copy previous code</button>

```{r seguro-popular-2-hint-1, eval = FALSE}
sps %>%
  filter(education %in% ...)
```

### Exercise 3

Use `select()` to exclude the columns `health_exp_1m` and `t2_health_exp_1m`. 

```{r seguro-popular-3, exercise = TRUE}

```

<button onclick = "transfer_code(this)">Copy previous code</button>

```{r seguro-popular-3-hint-1, eval = FALSE}
Remember that select(-...) returns all columns except for the 
specified column(s) that come after "-". When you use a vector, 
you only need one -.
```

```{r seguro-popular-3-hint-2, eval = FALSE}
... %>% 
  select(-c(..., ...))
```

### 

For columns following a certain name and a sequence of numbers, we can use `num_range()` helper. For more information about `num_range()`, see [this link](https://tidyselect.r-lib.org/reference/starts_with.html)

### Exercise 4

Because we want to visualize the impact of treatments, we need a measure of the change in expenses after the treatment is applied. Use `mutate()` to create a new variable, `change_in_expenses`. This variable should be equal to `t2_health_exp_3m - health_exp_3m`.


```{r seguro-popular-4, exercise = TRUE}

```

<button onclick = "transfer_code(this)">Copy previous code</button>

```{r seguro-popular-4-hint-1, eval = FALSE}
... %>% 
  mutate(... = t2_health_exp_3m - health_exp_3m) 
```

### 

From September 2005 to July 2006, Mexico encountered an inflation. `t2_health_exp_3m` contains the 3 months of health-related spendings from July 2006 to August 2006.

### Exercise 5

Using `group_by()` function, group the data by `treatment` and `education`.

```{r seguro-popular-5, exercise = TRUE}

```

<button onclick = "transfer_code(this)">Copy previous code</button>

```{r seguro-popular-5-hint-1, eval = FALSE}
... %>%
  group_by(...)
```

### 

To ensure the results are accurate, we need findings that support that health-related spending did in fact decrease in treatment group. Therefore, taking into the inflation account, the difference between` t2_health_exp_3m` and `health_exp_3m` should be lower for the treatment group. 

### Exercise 6

Use `summarize()` to calculate `mean_change_in_expenses`, the` mean()` of the `change_in_expenses` for each group. Set the argument `.groups` equal to "drop".

```{r seguro-popular-6, exercise = TRUE}
  
```

<button onclick = "transfer_code(this)">Copy previous code</button>

```{r seguro-popular-6-hint-1, eval = FALSE}
... %>% 
  summarize(... = mean(...),
            .groups = "drop")
```

### 

If we didn't specify the `.groups` argument, R would raise a warning because our groups would still exist. These unwanted existing groups may distort with future calculations. Therefore, we used `"drop"` to get rid of these groups. 



### Exercise 7

The `treatment` variable is in binary form, taking values 1 and 0. 
For clarification purposes, using `mutate`, change the `treatment` variable. Set every 1 equal to `Treatment Group` and every 0 to `Control Group`. 

### 

Use `ifelse()` for this. Within `ifelse()`, set condition where `treatment == "1"` to `Treatment Group` and `Control Group` in other conditions.

```{r seguro-popular-7, exercise = TRUE}

```

<button onclick = "transfer_code(this)">Copy previous code</button>

```{r seguro-popular-7-hint-1, eval = FALSE}
 ... %>% 
  mutate(treatment = ifelse(treatment == "...", "...", "Control Group")) 
```

### 

Alternatively, we could have used `if_else()` function from **[dplyr](https://www.rdocumentation.org/packages/dplyr/versions/0.7.8)** package. The difference between these two functions is that `if_else()` function is somewhat faster than base package function `ifelse()`.


### Exercise 8

Use `%>%` to add `ggplot()`.


```{r seguro-popular-8, exercise = TRUE}

```

<button onclick = "transfer_code(this)">Copy previous code</button>

```{r seguro-popular-8-hint-1, eval = FALSE}
.. %>% 
  ggplot()
```

### 

We see that `ggplot()` gives us a blank sheet. Now, we should specify aesthetics to change this. 


### Exercise 9

Within `aes` within `ggplot` object from previous exercise, map `education` to x-axis. Map `mean_change_in_expenses` to the y-axis, and `treatment` to the `fill`. 

```{r seguro-popular-9, exercise = TRUE}

```

<button onclick = "transfer_code(this)">Copy previous code</button>

```{r seguro-popular-9-hint-1, eval = FALSE}
.. %>% 
  ggplot(aes(x = "education",
             y = "mean_change_in_expenses",
             fill = "treatment"))
```

### 

Because we haven't specified the plot type yet, we don't see concrete results. We need to change that. 

### Exercise 10

Add the layer `geom_col()`.

```{r seguro-popular-10, exercise = TRUE}

```

<button onclick = "transfer_code(this)">Copy previous code</button>

```{r seguro-popular-10-hint-1, eval = FALSE}
.. %>% 
  ggplot(aes(x = "education",
             y = "mean_change_in_expenses",
             fill = "treatment")) + 
  geom_col()
```

### 

When you set the `fill` argument in the `ggplot` equal to a variable, ggplot by default sets a color set.

### Exercise 11

To make the bar charts color of your choice, you can use `scale_fill_manual` function. This function takes on values as a vector. Within this argument, set `values` equal to a vector of two colors: `cornflowerblue` and `darkturquoise`.

```{r seguro-popular-11, exercise = TRUE}

```

<button onclick = "transfer_code(this)">Copy previous code</button>

```{r seguro-popular-11-hint-1, eval = FALSE}
... +
  scale_fill_manual(values= c("cornflowerblue", "...")) +
  geom_col()
```

### 

If we had more categories of data, we also could have made use of   **RColorBrewer** package. This package provides a function named `scale_fill_brewer()`. With this function, you can specify a color palette of your choice. 

### Exercise 12

Within `geom_col()`, set the `position` argument equal to `"dodge"`. Moreover, you can also set the transparency of the bars with the argument `alpha`, where the default value of 1.0 is opaque. For our graph in this section, we set the `alpha` equal to 0.9. 

```{r seguro-popular-12, exercise = TRUE}

```

<button onclick = "transfer_code(this)">Copy previous code</button>

```{r seguro-popular-12-hint-1, eval = FALSE}
... +
  geom_col(position = "dodge", alpha = 0.9)
```

### 

Alternatively, we could have not specified position argument. In that case, we would see stacked bars, rather than side-by-side bars.

### Exercise 13

We also want to order bars in a descending educational level order.
In our case, we want the order "college", "high school, "secondary school", and "preschool".

### 

We can achieve this by setting `limits` argument of `scale_x_discrete()` equal to order of factors you want. We want the education levels in an increasing order. Therefore, pass in a vector of `preschool`, `secondary`, `high school`, and `college` in this order.

```{r seguro-popular-13, exercise = TRUE}

```

<button onclick = "transfer_code(this)">Copy previous code</button>

```{r seguro-popular-13-hint-1, eval = FALSE}
... +
   scale_x_discrete(limits = ...)
```

### 

We also could have other scaling methods. For instance, if we used `scale_x_reverse()`, our bars would be in reverse order, and x-axis labels would be in decreasing order.

### Exercise 14

It would also be more representative if the y-axis values were displayed with pesos sign, since the observed change in health-related expenses is in pesos in Mexico. 

### 

We can achieve this with `scale_y_continuous()` function. Within this function, set `labels` equal to `dollar_format()`. Within `dollar_format()`, set `suffix` equal to pesos sign, `₱`, and set `prefix` equal to `""`.

```{r seguro-popular-14, exercise = TRUE}

```

<button onclick = "transfer_code(this)">Copy previous code</button>

```{r seguro-popular-14-hint-1, eval = FALSE}
... +
   scale_y_continuous(labels = scales::dollar_format(suffix = "₱", 
                                                     prefix = "")) 
```

### 

`scale_y_continuous` have formatting values to dollar feature. However, it does not have it for other currencies. In those cases, we have to specify the currency sign by using `dollar_format()` argument and pass it to `labels`. 


### Exercise 15

Add `theme_minimal()` to change the style of the graph.

```{r seguro-popular-15, exercise = TRUE}

```

### 

Alternatively, we could have used themes such as `theme_light()` and `theme_dark()`. 



### Exercise 16

To finish your plot, use `labs()` to give the graph a title, subtitle, axis labels, and caption of your choice.

```{r seguro-popular-16, exercise = TRUE}

```

Reminder: This is what your plot should look like.

```{r sps15-answer}
sps_p
```

## Gender inequality 

This dataset shows the median weekly incomes for 535 different occupations. The data encompasses information for all working American citizens as of January 2015. The incomes are broken into male and female statistics, preceded by the total median income when including both genders.

### 

Let's create the following plot.

```{r gender-inequality}

income_p <- income %>%
  filter(f_weekly != "Na" & 
         m_weekly != 'Na' & 
         all_weekly != 'Na') %>%
  mutate(f_weekly = parse_number(f_weekly), 
         m_weekly = parse_number(m_weekly), 
         all_weekly = parse_number(all_weekly)) %>%
  mutate(occupation = str_to_lower(occupation)) %>%
  drop_na() %>%
  arrange(desc(all_weekly)) %>%
  slice(1:24) %>%
  select(occupation, m_weekly, f_weekly) %>%
  ggplot(aes(y = fct_reorder(occupation, m_weekly), 
             x = f_weekly, 
             xend = m_weekly)) +
  geom_dumbbell(size=1.5, 
                color="grey", 
                size_x=3, 
                size_xend = 3, 
                colour_x = 'cornflowerblue',
                colour_xend = 'darkslategray3') +
  scale_x_continuous(breaks = c(1000, 1250, 1500, 1750, 2000, 2250), 
                     label = dollar_format(c(1000,1250,1500,1750,2000,2250))) +
    theme_bw() + 
    theme(panel.grid.major.x = element_blank(),
          panel.grid.minor.x = element_blank()) +
    labs(y = NULL,
         x='Earnings', 
         subtitle='There is significant gender inequality in many areas.',
         title='Gender Inequality in 25  highest-paying jobs',
         caption = 'Source: Bureau of Labor Statistics')

income_p
  
```

### Exercise 1

`glimpse()` the `income` data set. Pay close attention to the data type of each variable.

```{r gender-inequality-1, exercise = TRUE}

```

We see that many character columns have `Na` values, but they are written as characters instead of NA format. 

### 

In cases where missing values are written as characters, we cannot use `drop_na()` since there are no NA types. 

### Exercise 2

`filter()` the columns `m_weekly`, `f_weekly`, and `all_weekly` so that they don't include columns where the values are `"Na"`.

```{r gender-inequality-2, exercise = TRUE}

```

```{r gender-inequality-2-hint-1, eval = FALSE}
income %>%
   filter(... =  != 'Na' & 
          f_weekly != '...' & 
          all_weekly != '...') 
```

### 

`all_weekly`, `m_weekly`, and `f_weekly` are median weekly including male and female workers, meian weekly income of only male workers, and median weekly income of only female workers in USD, respectively.

### Exercise 3

Because we want to get the highest-paying jobs, we need to arrange the tibble by `all_weekly`. 

### 

However, because this column is in character format, we have to convert it to numeric. 

Using `mutate`, overwrite the `all_weekly`, `m_weekly`, and `f_weekly`  columns using `parse_number()`. 

```{r gender-inequality-3, exercise = TRUE}

```

<button onclick = "transfer_code(this)">Copy previous code</button>

```{r gender-inequality-3-hint-1, eval = FALSE}
... %>%
  mutate(all_weekly = parse_number(...))
```

### 

Alternatively, we could have used the built-in R function `as.numeric()`.

### Exercise 4

    
For interpretability of results, it would be helpful if we converted `occupation`s to lowercase. We can do this by overwriting `occupation` column with `str_to_lower()` function.


```{r gender-inequality-4, exercise = TRUE}

```

<button onclick = "transfer_code(this)">Copy previous code</button>

```{r gender-inequality-4-hint-1, eval = FALSE}
... %>%
  mutate(occupation = str_to_lower(...)) %>%
```

### 

Alternatively, we coul have used `casefold()` function. This function is especially useful because we can change the conversion method with one argument: `upper`. If upper is `FALSE`, the result will be lowercase.

### Exercise 5

Now, although we have dropped the missing values in character columns, we have to use `drop_na()` to drop `NA`s in double columns that we will use. 

```{r gender-inequality-5, exercise = TRUE}

```

<button onclick = "transfer_code(this)">Copy previous code</button>

```{r gender-inequality-5-hint-1, eval = FALSE}
... %>%
  drop_na()
```

### Exercise 6

To get the highest-paying jobs, we have to order the tibble in decreasing order by `all_weekly` column.

```{r gender-inequality-6, exercise = TRUE}

```

<button onclick = "transfer_code(this)">Copy previous code</button>

```{r gender-inequality-6-hint-1, eval = FALSE}
... %>% 
  arrange(desc(...)) 
```

### 

Alternatively, we could have used `order()` function to sort rows. We could have used a code like the following: 

```
income[order(income$all_weekly),]
```
### Exercise 7

Now that we have ordered the tibble, we have to get 25 most-paying jobs. We can do this with `slice()`. 


```{r gender-inequality-7, exercise = TRUE}

```

<button onclick = "transfer_code(this)">Copy previous code</button>

```{r gender-inequality-7-hint-1, eval = FALSE}
...%>%
  slice(1:24)
```

### 

Instead of `slice()`, we can use the base R function `head()` to get the first 25 rows.

### Exercise 8

Select `occupation`, `m_weekly`, and `f_weekly` columns. 


```{r gender-inequality-8, exercise = TRUE}

```

<button onclick = "transfer_code(this)">Copy previous code</button>

```{r gender-inequality-8-hint-1, eval = FALSE}
...  %>%
   select(..., m_weekly, ...)
```

### 

Alternatively, we could have used select helpers to select columns. For example, to get the columns about only male, we would use `starts_with()`, as shown like the following: `select(starts_with("m_))`. 

### Exercise 9

To create our plot, we will use `geom_dumbbell()` object of `ggalt` package.

### 

Create the `ggplot()` object. Within `aes`argument, set`y` equal to`occupation` column, set `x` equal to `f_weekly`, and `xend` to `m_weekly`.

```{r gender-inequality-9, exercise = TRUE}

```

<button onclick = "transfer_code(this)">Copy previous code</button>

```{r gender-inequality-9-hint-1, eval = FALSE}
... %>%
  ggplot(aes(y = occupation, 
             x = f_weekly, 
             xend = ...)) 
```

### 

Right now, because we haven't specified the `geom` object, we don't see any graph. 

### Exercise 10

Add `geom_dumbbell()`.

```{r gender-inequality-10, exercise = TRUE}

```

<button onclick = "transfer_code(this)">Copy previous code</button>

```{r gender-inequality-10-hint-1, eval = FALSE}
... + 
  geom_dumbbell()
```

### 

Alternatively, to visualize the earning difference between male and female, we could have created a new variable that is `m_weekly - f_weekly` and use `geom_col()`to graph it. 

### Exercise 11

Currently, our graph is not easy to read As the first step on the way of making it easy-to-analyse, order values by `m_weekly`. 

```{r gender-inequality-11, exercise = TRUE}

```

<button onclick = "transfer_code(this)">Copy previous code</button>

```{r gender-inequality-11-hint-1, eval = FALSE}
... %>%
  ggplot(aes(y = fct_reorder(occupation, ...), 
             x = f_weekly, 
             xend = m_weekly)) + 
  geom_dumbbell()
```

### 

Instead of `fct_reorder()`, we could use `reorder()` function. 

### Exercise 12

Now for color and size selection for the graph, manipulate the `geom_dumbbell()` object's arguments. 

### 

Set `size` to 1.5, `size_x` to 3, and `size_xend` to 3. 

```{r gender-inequality-12, exercise = TRUE}

```

<button onclick = "transfer_code(this)">Copy previous code</button>

```{r gender-inequality-12-hint-1, eval = FALSE}
... + 
  geom_dumbbell(size=1.5, 
                size_x=..., 
                size_xend = ...)
```

### 

`size` argument is used to specify the size of the line connecting points. And `size_x` and `size_xend` are used to change the size of the points corresponding to `x` and `xend` argument values specified in `ggplot()` object, respectively. 

### Exercise 13

Within the `geom_dumbbell()` object, change color-related arguments: set `color` equal to `grey`, `colour_x` to `cornflowerblue`, and `colour_xend` to `darkslategray3`. 

```{r gender-inequality-13, exercise = TRUE}

```

<button onclick = "transfer_code(this)">Copy previous code</button>

```{r gender-inequality-13-hint-1, eval = FALSE}
... + 
  geom_dumbbell(size=1.5, 
                color="grey", 
                size_x=3, 
                size_xend = 3, 
                colour_x = '...', 
                colour_xend = '...')
```

### 

`color` argument is used to specify the color of the line connecting the points.


### Exercise 14

Because x-axis ticks overlap, it'd be more readable if we selected only specific ticks.

### 

Within `scale_x_continuous()` function, set `breaks` argument equal to a vector of six values: 1000, 1250, 1500, 1750, 2000, and 2250. 

```{r gender-inequality-14, exercise = TRUE}

```

<button onclick = "transfer_code(this)">Copy previous code</button>

```{r gender-inequality-14-hint-1, eval = FALSE}
... + 
  scale_x_continuous(... = c(1000, 1250, 1500, 1750, 2000, 2250), 
                   label = ...(c(1000,1250,1500,1750,2000,2250))) +
```

### 

`scale_x_sqrt()` is used to take the square root of x-axis values. 

### Exercise 15

Because the earnings in this dataset is in dollars, we should format x-axis tick labels with dollar sign. Within `scale_x_continuous()` from previous exercise, set `label` argument equal to `dollar_format()` that has used for breaks.   

```{r gender-inequality-15, exercise = TRUE}

```

<button onclick = "transfer_code(this)">Copy previous code</button>

```{r gender-inequality-15-hint-1, eval = FALSE}
... + 
scale_x_continuous(breaks = c(1000, 1250, 1500, 1750, 2000, 2250), 
                   label = ...(c(1000, 1250, 1500, 1750, 2000, 2250))) +
```

###

`scales::percent_format()` is used to format values in percent format. For example, 40 becomes 40%.

### Exercise 16

Add `theme_bw()`. 

```{r gender-inequality-16, exercise = TRUE}

```

<button onclick = "transfer_code(this)">Copy previous code</button>

```{r gender-inequality-16-hint-1, eval = FALSE}
... + 
  theme_bw() 
```

### 

Using package **[ggthemes](https://jrnold.github.io/ggthemes/)**, we can access many more themes such as `theme_tufte` and `theme_calc`. 

### Exercise 17

Because we want to analyse general trends, grid lines do not provide very much information. Therefore, we can eliminate them. 

### 

Within `theme()`, set `panel.grid.major.x` to `element_blank()`, and `panel.grid.minor.x` to `element_blank()`.

```{r gender-inequality-17, exercise = TRUE}

```

<button onclick = "transfer_code(this)">Copy previous code</button>

```{r gender-inequality-17-hint-1, eval = FALSE}
... + 
  theme(
    panel.grid.major.x = element_blank(),
    panel.grid.minor.x = element_blank()) 
```

### 

One of the arguments of `theme`, `panel.background`,  is used to change the elements of the background of the plotting area.

`panel.ontop` is a logical argument used within `theme()` to set whether the grid lines will be over the graph. 

### Exercise 18

To finish your plot, use `labs()` to give the graph a title, subtitle, axis labels, legend labels, and caption of your choice.

Reminder: This is what your plot should look like. 

```{r gender-inequality-18}
income_p
```

```{r gender-inequality-16, exercise = TRUE}

```

```{r gender-inequality-18-hint-1, eval = FALSE}
... + 
  labs(...)
```

## Last letter of boy names

Library `babynames` contains data about baby names through many years. 

### 

Using this data, let's create the folllowing graph.

```{r baby-lastnames}
boys_p <- babynames %>%
  filter(sex == 'M') %>%
  select(name, year, prop) %>%
  group_by(last_letter = stringr::str_sub(name, -1, -1), year) %>%
  summarize(frequency = sum(prop), .groups = 'drop') %>%
  ggplot(aes(x = year, y = frequency, colour = last_letter)) +
    geom_line() + 
    gghighlight(max(frequency) > 0.15,
                label_key = last_letter) + 
    scale_x_continuous(guide = guide_axis(angle = 70),
                       breaks = c(1880, 1900, 1925, 1950,
                                  1975, 2000, 2017)) +
    scale_y_continuous(labels = scales::percent_format()) +
    theme_minimal() + 
    labs(x = NULL,
         y = NULL,
         subtitle = "Names ending with 'N' increased rapidly after 1950",
         title = "Last Letter of Boy Baby Names",
         caption = "Source: http://hadley.github.io/babynames")

boys_p
```

### Exercise 1

`glimpse()` the `babynames` data set. Pay close attention to the data type of each variable.

```{r last-letter-of-boy-n-1, exercise = TRUE}

```

### 

We could have also used `head()` function to have insights about the dataset.

### Exercise 2

To check for NA values, use `any()` function with argument `is.na()`, argument of which should be the dataset. 

```{r last-letter-of-boy-n-2, exercise = TRUE}

```

```{r last-letter-of-boy-n-2-hint-1, eval = FALSE}
any(is.na(...))
```

### 

This function returned `FALSE`, which indicates that there is no NA values. 

### Exercise 3

Because we are trying to analyse only boy names by last letter, `filter()` the data set to only get the data of boy names. 

```{r last-letter-of-boy-n-3, exercise = TRUE}

```

```{r last-letter-of-boy-n-3-hint-1, eval = FALSE}
babynames %>%
  filter(... == 'M')

```

### Exercise 4

Extract only `name`, `year`, and `prop` columns. 

```{r last-letter-of-boy-n-4, exercise = TRUE}

```

<button onclick = "transfer_code(this)">Copy previous code</button>

```{r last-letter-of-boy-n-4-hint-1, eval = FALSE}
...  %>%
  select(..., ..., ...)
```

### 

When selecting columns, we can also combine multiple select helpers. For example,
when selecting `name` and `year` columns, we can use the following code: 
`select(starts_with("na") | ends_with("ar")) `.

### Exercise 5

We want the last letters of boy names. Therefore, create a new variable names `last_letters` that should be equal to last letter of each boy name.To get the last letter of each boy name, we will make use of `str_sub()` function of **[stringr](https://stringr.tidyverse.org/)** package. 

### 

Pass `name` -1 and -1 arguments to `str_sub()`. Since we will use this variable only for grouping, you can create it within the `group_by()` function. Moreover, because we will also calculate popularities of last letters *by year*, pass `year` into the `group_by()` function as well.

```{r last-letter-of-boy-n-5, exercise = TRUE}

```

<button onclick = "transfer_code(this)">Copy previous code</button>

```{r last-letter-of-boy-n-5-hint-1, eval = FALSE}
... %>%
  group_by(last_letter = stringr::str_sub(..., ..., -1), ...)
```

### 

`str_sub` takes three arguments: character vector to work on, starting character, and ending character. Because we wanted to extract last letter, or -1 element, of each name, we set the starting and ending characters as -1.


### Exercise 6

Use `summarize()` to create the variable `frequencies` that is equal to `sum()` of proportions of each group. 

Moreover, to avoid warning and since we are done with groups, pass in the `.groups` argument and set it equal to `drop`. 

```{r last-letter-of-boy-n-6, exercise = TRUE}

```

<button onclick = "transfer_code(this)">Copy previous code</button>

```{r last-letter-of-boy-n-6-hint-1, eval = FALSE}
... %>% 
   summarize(frequency = sum(prop), .groups = 'drop') 
```

### Exercise 7

Now, create a ggplot object, and within `ggplot(aes())`, set x-axis values to `year`, y-axis values to `frequencies`, and colour to `last_letter.` 


```{r last-letter-of-boy-n-7, exercise = TRUE}

```

<button onclick = "transfer_code(this)">Copy previous code</button>

```{r last-letter-of-boy-n-7-hint-1, eval = FALSE}
...%>%
  ggplot(aes(x = ..., y = ..., colour = ...)) 
```

### Exercise 8

Add `geom_line()` to the ggplot object from previous exercise.


```{r last-letter-of-boy-n-8, exercise = TRUE}

```

<button onclick = "transfer_code(this)">Copy previous code</button>

```{r last-letter-of-boy-n-8-hint-1, eval = FALSE}
...  +
  geom_line()
```

### 

Alternatively, we could have used other chart types such as scatter chart. However, for our goal, line plot is a great option. 

### Exercise 9

Because we want to analyse last letters that are prevalent, we want to color only last letters that have been above a certainn threshold.

### 

We use 15% as the threshold. Therefore, we only want to color last letters that for certain time have been the last letter of more than 15% of all baby boys that were born during that time. 

### 

We will utilize `gghighlight` library for this purpose. Add `gghighlight()` to the ggplot object. Within this function, set `max()` frequency to be greater than 0.15, and to avoid any warnings, set `label_key` equal to `last_letter`.

```{r last-letter-of-boy-n-9, exercise = TRUE}

```

<button onclick = "transfer_code(this)">Copy previous code</button>

```{r last-letter-of-boy-n-9-hint-1, eval = FALSE}
...+ 
  gghighlight(max(...) > ...,
                label_key = ...) 
```

### 

We don't think current x-axis ticks are informative enough. Therefore, we should set custom x-axis ticks.

### Exercise 10

Add `scale_x_continuous`, and within this function, set `breaks` argument equal to numerical vector of years. You can choose any years within the data set. We preferred 1880, 1900, 1925, 1950, 1975, 2000, and 2017. 

```{r last-letter-of-boy-n-10, exercise = TRUE}

```

<button onclick = "transfer_code(this)">Copy previous code</button>

```{r last-letter-of-boy-n-10-hint-1, eval = FALSE}
... +
  scale_x_continuous(breaks = c(1880, 1900, ..., ...,
                                ..., 2000, 2017)) 
```

### 

A rule of thumb, however, is to include ending and beginning years so that whoever sees your plot could understand the range of years that data is collected.

### Exercise 11

Moreover, we want to visualize y-axis as percentage instead of proportion. Therefore, add `scale_y_continuous`, and within this function, set labels argument equal to `scales::percent_format()`.

```{r last-letter-of-boy-n-11, exercise = TRUE}

```

<button onclick = "transfer_code(this)">Copy previous code</button>

```{r last-letter-of-boy-n-11-hint-1, eval = FALSE}
... +
  scale_y_continuous(... = scales::...()) 
```

### 

`scale` library provides many functions to assist the scaling of axes. For example, `scale_y_binned()` can be used to discretize continuous position data.

### Exercise 12

Add `theme_minimal()`. 

```{r last-letter-of-boy-n-12, exercise = TRUE}

```

<button onclick = "transfer_code(this)">Copy previous code</button>

```{r last-letter-of-boy-n-12-hint-1, eval = FALSE}
... +
  theme_minimal()
```

### 

We also could have used themes such as `theme_gray()`, `theme_void()`, and`theme_bw()`.

### Exercise 13

Finally, add `caption`, `title`, `subtitle`, and `axis` labels of your choice. Add `labs()` function to the plot. 

Reminder: This is what your plot should look like

```{r last-letter-of-boy-n-13}
boys_p
```

```{r baby-lastnames-13, exercise = TRUE}

```

<button onclick = "transfer_code(this)">Copy previous code</button>

```{r last-letter-of-boy-n-13-hint-1, eval = FALSE}
... +
  labs(...)
```

### 

```{r download-answers, child = "../../child_documents/download_answers.Rmd"}
```
