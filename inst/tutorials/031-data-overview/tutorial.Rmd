---
title: 'Data: Overview'
tutorial:
  id: data-overview
output:
  learnr::tutorial:
    progressive: yes
    allow_skip: yes
runtime: shiny_prerendered
description: 'Tutorial overview for Chapter 3: Data'
---

```{r setup, include = FALSE}
library(learnr)
library(all.primer.tutorials)
library(tidyverse)
library(rvest)
knitr::opts_chunk$set(echo = FALSE)
options(tutorial.exercise.timelimit = 60, 
        tutorial.storage = "local") 


# Web scraping

html_2 <- minimal_html("
  <h1>This is a heading</h1>
  <p id='first'>This is a paragraph</p>
  <p class='important'>This is an important paragraph</p>
")

```

```{r copy-code-chunk, child = "../../child_documents/copy_button.Rmd"}
```

```{r info-section, child = "../../child_documents/info_section.Rmd"}
```

## Introduction
### 

This tutorial covers the material in [Chapter 3: Data](https://ppbds.github.io/primer/03-data.html) from [*Preceptor's Primer for Bayesian Data Science*](https://ppbds.github.io/primer/). 

## Web scaping basics
### 

This section and the next includes material about [web scraping](https://r4ds.hadley.nz/webscraping.html), based on [*R for Data Science (2e)*](https://r4ds.hadley.nz/) by Hadley Wickham, Mine Çetinkaya-Rundel, and Garrett Grolemund.



### Exercise 1

The key package for web scraping with R is [**rvest**](https://rvest.tidyverse.org/). Load the **rvest** library.

```{r web-scaping-basics-1, exercise = TRUE}

```

```{r web-scaping-basics-1-hint-1, eval = FALSE}
library(rvest)
```

### 

The "Web Scraping 101" [article](https://rvest.tidyverse.org/articles/rvest.html) from the **rvest** [homepage](https://rvest.tidyverse.org/) provides useful background. 

### Exercise 2

Look up the help page for the **rvest** package using the `help()` function. Don't forget to use the `package` argument.

```{r web-scaping-basics-2, exercise = TRUE}

```

```{r web-scaping-basics-2-hint-1, eval = FALSE}
help(package = "...")
```

### 

The help page for a package provides a listing of all the functions in a package. Note that there are both `html_text()` and `html_text2()` functions. You should always use `html_text2()` unless you have a good reason not to.

### Exercise 3

Click on the link to the DESCRIPTION file which appeared when you looked up the help page for **rvest**. Copy the the first two lines (Package and Title) below.

```{r web-scaping-basics-3}
question_text(NULL,
	answer(NULL, correct = TRUE),
	allow_retry = TRUE,
	try_again_button = "Edit Answer",
	incorrect = NULL,
	rows = 3)
```

### 

As the DESCRIPTION file mentions, **rvest** is most supplying wrappers for the more lower level (but harder to use) **xml2** and **httr** packages. (As always, note how we, and everyone else) uses the words "package" and "library" interchangeably.

### Exercise 4

`minimal_html()` is an **rvest** function used for teaching. It turns text into an HTML document. Run `minimal_html()` with "test" as its first argument.

```{r web-scaping-basics-4, exercise = TRUE}

```

```{r web-scaping-basics-4-hint-1, eval = FALSE}
minimal_html("test")
```

### 

HTML stands for **H**yper**T**ext **M**arkup **L**anguage, the underlying text of the web. The main difference between HTML and plain text is the use of various "elements" and "attributes" which tell your browser how to display the text.

### Exercise 5

Rerun the code above, but assign the result of the call to `minimal_html()` to an object called `html_1`. Then, on the next line, pass `html_1` as the argument to the function `class()`.


```{r web-scaping-basics-5, exercise = TRUE}

```

<button onclick = "transfer_code(this)">Copy previous code</button>

```{r web-scaping-basics-5-hint-1, eval = FALSE}
html_1 <- minimal_html("test")
class(html_1)
```

### 

HTML documents are an example from the broader class of XML objects. Recall that **rvest** is mostly a wrapper for the **xml2** package, which allows us to work with XML objects.

### Exercise 6

Use `minimal_html()` to create a more complex HTML document by running this code. Then, below this code, add `html_2` so that we can example the object.


```{r web-scaping-basics-6, exercise = TRUE}
html_2 <- minimal_html("
  <h1>This is a heading</h1>
  <p id='first'>This is a paragraph</p>
  <p class='important'>This is an important paragraph</p>
")
```

```{r web-scaping-basics-6-hint-1, eval = FALSE}
html_2
```

### 

Just typing/returning `html_2` produces the same result as `print(html_2)`. By design, the `print()` function should provide the key information about the object. The first line tells us that `html_2` is an HTML document. The two listed elements ("head" and "body") are the two key parts of every HTML document. The "body" us the most important part since it contains all the information.

### Exercise 7

We have added `html_2` to your workspace so that you can use it to start pipes. Pipe `html_2` to `html_elements("p")`.

```{r web-scaping-basics-7, exercise = TRUE}

```

```{r web-scaping-basics-7-hint-1, eval = FALSE}
html_2 |> 
  html_elements("...")
```

### 

`html_elements()` pulls out all the elements that match the selector, which is provided to the `css` argument. "Elements" consist of a start tag (e.g. <p>), optional attributes (id='first'), an end tag4 (like </p>). The "contents" of an element are everything in between the start and end tag.

Since there are two elements with the "p" tag, where the "p" is for "paragraph," the result from html_elements() are those two elements. The element with the "h1" tag is not included.

### Exercise 8

Pipe `html_2` to `html_elements(".important")`. Note that the `css` argument is ".important" --- with a leading dot --- even though the attribute is "important" without a dot. 


```{r web-scaping-basics-8, exercise = TRUE}

```

```{r web-scaping-basics-8-hint-1, eval = FALSE}
html_2 |> 
  html_elements(".important")
```

### 

When using `html_elements()` to select nodes on the basis of the class attribute rather than a tags we need a leading dot. Tags, on the other hand, are provided as is. Notice that the result of a call to `html_elements()` is an "xml_nodeset" rather than a full HTML document.

### Exercise 9

Pipe `html_2` to `html_elements("#first")`. Note that the `css` argument is "#first" --- with a leading hash mark --- even though the attribute, an id in this case, is "first" without a hash mark 

```{r web-scaping-basics-9, exercise = TRUE}

```

```{r web-scaping-basics-9-hint-1, eval = FALSE}
html_2 |> 
  html_elements("...")
```

### 

Id attributes must be unique within a document, so this will only ever select a single element.






## Web scaping examples
### 

Consider two examples of material we might want to scrape. The [first](https://rvest.tidyverse.org/articles/starwars.html) is information about 7 Star Wars films from a vignette from the **rvest** package. The second involves the [250 highest rated films](https://www.imdb.com/chart/top) from IMDB. In this Section, we will scape and organize information from both.

### Exercise 1

Examine the [webpage](https://rvest.tidyverse.org/articles/starwars.html) for the Star Wars films. The url is `https://rvest.tidyverse.org/articles/starwars.html`. Pipe this url to `read_html()`. (Be sure to surround the url with quotation marks.)

```{r web-scaping-examples-1, exercise = TRUE}

```

```{r web-scaping-examples-1-hint-1, eval = FALSE}
"https://rvest.tidyverse.org/articles/starwars.html" |> 
  read_..()
```

### 

The structure of the underlying HTML looks like this:

````
<section>
  <h2 data-id="1">The Phantom Menace</h2>
  <p>Released: 1999-05-19</p>
  <p>Director: <span class="director">George Lucas</span></p>
  
  <div class="crawl">
    <p>...</p>
    <p>...</p>
    <p>...</p>
  </div>
</section>
````

### Exercise 2

Continue the pipe with `html_elements("section")`

```{r web-scaping-examples-2, exercise = TRUE}

```

<button onclick = "transfer_code(this)">Copy previous code</button>

```{r web-scaping-examples-2-hint-1, eval = FALSE}
... |> 
  html_elements("..")

```

### 

We almost always begin scraping by creating an html document which can then be manipulated with functions like `html_elements()`. Note that `html_elements()` is not the same thing as `html_element()`, without the "s".

### Exercise 3

Continue the pipe with `html_element("h2")`. We want to pull out just the title of each movie. We can see that the titles are tagged with "h2".

```{r web-scaping-examples-3, exercise = TRUE}

```

<button onclick = "transfer_code(this)">Copy previous code</button>

```{r web-scaping-examples-3-hint-1, eval = FALSE}
... |> 
  html_element("h2")
```

### 

Note that we used `html_element()` in this example, as opposed to `html_elements()` (with the "s") last time. In this case, both functions produce the same answer.

### Exercise 4

Continue the pipe with `html_text2()`. We almost always want to clean up the underlying text before making use of it. Never use `html_text()` (without the "2") unless you have a good reason to.


```{r web-scaping-examples-4, exercise = TRUE}

```

<button onclick = "transfer_code(this)">Copy previous code</button>

```{r web-scaping-examples-4-hint-1, eval = FALSE}
... |> 
  html_...()
```

This character vector is the result we are looking for. 

### Exercise 5

Place the above chunk of code into the middle of a call to `tibble()` in which you are creating a tibble with one variable, `title`, which is the title of each movie. The resulting tibble should have one column and seven rows.


```{r web-scaping-examples-5, exercise = TRUE}

```

<button onclick = "transfer_code(this)">Copy previous code</button>

```{r web-scaping-examples-5-hint-1, eval = FALSE}
tibble(title = 
         "https://rvest.tidyverse.org/articles/starwars.html" |> 
         read_html() |> 
         html_elements("section") |> 
         html_elements("h2") |> 
         html_text2())
```

### 

We can use the same approach to add other variables to this tibble, like the director and release date. To avoid code duplication, we should create an object, perhaps called `section`, which is the result of the first three steps in the pipe. Then, each variable creation would look something like

```{r, echo = TRUE}
section <- "https://rvest.tidyverse.org/articles/starwars.html" |> 
         read_html() |> 
         html_elements("section")

tibble(title = section |> html_elements("h2") |> html_text2(),
       director = section |> html_element(".director") |> html_text2())
```

### 

You now understand web scraping. This Section and the previous one were based on the [web scraping](https://r4ds.hadley.nz/webscraping.html) material from [*R for Data Science (2e)*](https://r4ds.hadley.nz/) by Hadley Wickham, Mine Çetinkaya-Rundel, and Garrett Grolemund.



## Summary
### 

This tutorial was an overview of the material in [Chapter 3: Data](https://ppbds.github.io/primer/03-data.html) from [*Preceptor's Primer for Bayesian Data Science*](https://ppbds.github.io/primer/). 



```{r download-answers, child = "../../child_documents/download_answers.Rmd"}
```
